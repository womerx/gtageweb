<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Monkey Tag Online</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;overflow:hidden;font-family:'Courier New',monospace;cursor:default;touch-action:none;}
canvas{display:block;}
body.ingame{user-select:none;}
#menu-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:300;background:rgba(0,0,0,0.75);}
#menu-box{background:rgba(4,12,4,0.99);border:2px solid #00ff44;border-radius:10px;width:min(380px,95vw);padding:28px 26px 24px;box-shadow:0 0 60px rgba(0,255,68,0.25);}
#menu-title{text-align:center;margin-bottom:20px;}
#menu-title h1{font-size:clamp(1.6rem,5vw,2.2rem);font-weight:900;letter-spacing:.1em;color:#00ff44;text-shadow:0 0 30px #00ff44;text-transform:uppercase;margin-bottom:4px;}
#menu-title .sub{color:#335533;font-size:.65rem;letter-spacing:.3em;text-transform:uppercase;}
#srv-status{text-align:center;font-size:.62rem;letter-spacing:.1em;color:#446644;margin-bottom:16px;padding:6px;background:rgba(0,0,0,0.3);border-radius:4px;}
.ig{margin-bottom:12px;}
.ig label{color:#557755;font-size:.62rem;letter-spacing:.18em;text-transform:uppercase;display:block;margin-bottom:5px;}
.ig input{width:100%;padding:10px 13px;background:#070e07;border:1px solid #1a331a;color:#00ff44;font-family:'Courier New',monospace;font-size:.95rem;border-radius:4px;outline:none;transition:border-color .2s;}
.ig input:focus{border-color:#00ff44;}
.ig input[readonly]{color:#00ff88;border-color:#226622;}
.btn{width:100%;padding:12px;margin-top:8px;background:transparent;border:2px solid #00ff44;color:#00ff44;font-family:'Courier New',monospace;font-size:.82rem;font-weight:700;letter-spacing:.18em;text-transform:uppercase;cursor:pointer;border-radius:4px;transition:all .15s;}
.btn:hover,.btn:active{background:#00ff44;color:#000;box-shadow:0 0 20px rgba(0,255,68,.4);}
.btn.sec{border-color:#1a441a;color:#2a5a2a;}
.btn.sec:hover,.btn.sec:active{border-color:#00aa33;color:#00aa33;background:transparent;box-shadow:none;}
.divider{border:none;border-top:1px solid #1a331a;margin:16px 0;}
#host-box{display:none;background:#050d05;border:1px solid #1a331a;border-radius:4px;padding:12px 12px 4px;margin-top:10px;}
#hud{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;display:none;z-index:10;}
#crosshair{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:14px;height:14px;}
#crosshair::before,#crosshair::after{content:'';position:absolute;background:rgba(255,255,255,.55);}
#crosshair::before{width:2px;height:14px;left:6px;top:0;}
#crosshair::after{width:14px;height:2px;left:0;top:6px;}
#pcount{position:fixed;top:14px;right:14px;color:#00ff44;font-size:.72rem;letter-spacing:.1em;text-shadow:0 0 8px #00ff44;}
#lcode{position:fixed;top:14px;left:14px;color:#335533;font-size:.65rem;letter-spacing:.06em;}
#hint{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);color:#2a472a;font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;white-space:nowrap;}
#status{position:fixed;bottom:50px;left:50%;transform:translateX(-50%);font-size:.75rem;letter-spacing:.08em;opacity:0;transition:opacity .4s;text-transform:uppercase;background:rgba(0,0,0,.85);padding:6px 16px;border-radius:4px;white-space:nowrap;pointer-events:none;}
#menu-btn{position:fixed;top:12px;left:50%;transform:translateX(-50%);padding:6px 18px;background:rgba(0,16,0,0.85);border:1px solid #2a4a2a;color:#446644;font-family:'Courier New',monospace;font-size:.6rem;letter-spacing:.15em;text-transform:uppercase;cursor:pointer;border-radius:3px;pointer-events:all;transition:all .15s;display:none;z-index:60;}
#menu-btn:hover{border-color:#00ff44;color:#00ff44;}
#chat-wrap{position:fixed;bottom:40px;left:14px;width:290px;pointer-events:none;display:none;z-index:55;}
#chat-messages{max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:3px;padding-bottom:4px;scrollbar-width:none;}
#chat-messages::-webkit-scrollbar{display:none;}
.chat-msg{background:rgba(0,0,0,0.65);border-radius:3px;padding:4px 9px;font-size:.68rem;color:#aaffcc;letter-spacing:.04em;line-height:1.4;animation:fadeIn .2s ease;word-break:break-word;}
.chat-msg .cn{color:#00ff88;font-weight:700;}
.chat-msg.sys{color:#446644;font-style:italic;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:none;}}
#chat-input-row{display:flex;gap:5px;margin-top:5px;pointer-events:all;}
#chat-input{flex:1;padding:8px 11px;background:rgba(0,10,0,0.92);border:1px solid #1a441a;color:#00ff44;font-family:'Courier New',monospace;font-size:.75rem;border-radius:3px;outline:none;transition:border-color .2s;}
#chat-input:focus{border-color:#00ff44;}
#chat-send{padding:8px 11px;background:transparent;border:1px solid #00ff44;color:#00ff44;font-family:'Courier New',monospace;font-size:.7rem;cursor:pointer;border-radius:3px;transition:all .15s;white-space:nowrap;}
#chat-send:hover{background:#00ff44;color:#000;}
#chat-toggle{display:none;position:fixed;bottom:140px;right:24px;width:52px;height:52px;border-radius:50%;background:rgba(0,28,0,0.88);border:2px solid rgba(0,200,80,0.55);color:#00ff88;font-size:1.3rem;align-items:center;justify-content:center;pointer-events:all;cursor:pointer;z-index:60;}
#chat-unread{position:absolute;top:-4px;right:-4px;background:#ff4444;color:#fff;font-size:.52rem;width:16px;height:16px;border-radius:50%;display:none;align-items:center;justify-content:center;font-weight:700;}
#mobile-controls{position:fixed;bottom:0;left:0;width:100%;height:100%;pointer-events:none;display:none;z-index:50;}
#joy-zone{position:absolute;bottom:0;left:0;width:50%;height:100%;pointer-events:all;}
#joy-base{position:absolute;width:110px;height:110px;border-radius:50%;background:rgba(255,255,255,0.07);border:2px solid rgba(255,255,255,0.18);transform:translate(-50%,-50%);display:none;}
#joy-stick{position:absolute;width:46px;height:46px;border-radius:50%;background:rgba(0,255,130,0.45);border:2px solid rgba(0,255,130,0.8);transform:translate(-50%,-50%);display:none;}
#look-zone{position:absolute;bottom:0;right:0;width:50%;height:100%;pointer-events:all;}
#jump-btn{position:absolute;bottom:40px;right:28px;width:80px;height:80px;border-radius:50%;background:rgba(0,255,100,0.12);border:3px solid rgba(0,255,100,0.55);display:flex;align-items:center;justify-content:center;color:#00ff88;font-size:1.5rem;font-weight:900;pointer-events:all;transition:background .1s,transform .1s;user-select:none;}
#jump-btn.pressed{background:rgba(0,255,100,0.38);transform:scale(.93);}
</style>
</head>
<body>
<canvas id="c"></canvas>

<div id="menu-overlay">
  <div id="menu-box">
    <div id="menu-title"><h1>ü¶ç Monkey Tag</h1><div class="sub">online ¬∑ multiplayer</div></div>
    <div id="srv-status">‚è≥ Checking server...</div>
    <div class="ig"><label>Your Name</label><input type="text" id="nameInput" placeholder="Enter name..." maxlength="16" value="Monkey"></div>
    <button class="btn" id="joinPublicBtn">‚ñ∂ Join Public Lobby</button>
    <hr class="divider">
    <button class="btn sec" id="hostBtn">‚äï Host Private Lobby</button>
    <div id="host-box">
      <div class="ig" style="margin-top:6px;"><label>Your Code ‚Äî share with friends</label><input type="text" id="generatedCode" readonly></div>
      <button class="btn" id="startHostBtn">‚ñ∂ Enter as Host</button>
    </div>
    <div class="ig" style="margin-top:12px;"><label>Join Private ‚Äî enter code</label><input type="text" id="codeInput" placeholder="e.g. AB12CD" maxlength="8"></div>
    <button class="btn sec" id="joinPrivBtn">‚Üí Join Private Lobby</button>
  </div>
</div>

<div id="hud">
  <div id="crosshair"></div>
  <div id="pcount">Players: 1</div>
  <div id="lcode"></div>
  <div id="hint">WASD ¬∑ Move &nbsp;|&nbsp; SPACE ¬∑ Jump &nbsp;|&nbsp; RMB ¬∑ Look &nbsp;|&nbsp; T ¬∑ Chat</div>
  <div id="status"></div>
  <button id="menu-btn">‚ò∞ Menu</button>
</div>

<div id="chat-wrap">
  <div id="chat-messages"></div>
  <div id="chat-input-row">
    <input type="text" id="chat-input" placeholder="Press T to chat..." maxlength="80">
    <button id="chat-send">Send</button>
  </div>
</div>
<div id="chat-toggle">üí¨<div id="chat-unread"></div></div>

<div id="mobile-controls">
  <div id="joy-zone"><div id="joy-base"></div><div id="joy-stick"></div></div>
  <div id="look-zone"></div>
  <div id="jump-btn">‚ñ≤</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
'use strict';
const WS_SERVER='wss://proactive-beauty-production.up.railway.app';
const isMobile=('ontouchstart' in window)||navigator.maxTouchPoints>0;

const canvas=document.getElementById('c');
const renderer=new THREE.WebGLRenderer({canvas,antialias:true});
renderer.setPixelRatio(Math.min(devicePixelRatio,isMobile?1.5:2));
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
renderer.shadowMap.type=THREE.PCFSoftShadowMap;
renderer.setClearColor(0x7ec8e3);
const scene=new THREE.Scene();
scene.fog=new THREE.FogExp2(0x7ec8e3,0.013);
const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.05,300);
const CAM_DIST=5.5,CAM_HEIGHT=2.8;

const sun=new THREE.DirectionalLight(0xfff8e0,1.4);
sun.position.set(40,80,30);sun.castShadow=true;
sun.shadow.mapSize.set(1024,1024);
sun.shadow.camera.far=200;sun.shadow.camera.left=sun.shadow.camera.bottom=-60;
sun.shadow.camera.right=sun.shadow.camera.top=60;
scene.add(sun,new THREE.AmbientLight(0x88bbdd,0.7),new THREE.HemisphereLight(0x87ceeb,0x2d5a1b,0.5));

const PLATE_SIZE=100,PLATE_DIVS=20,tileSize=PLATE_SIZE/PLATE_DIVS;
const baseSlab=new THREE.Mesh(new THREE.BoxGeometry(PLATE_SIZE,1.5,PLATE_SIZE),new THREE.MeshLambertMaterial({color:0x3a6020}));
baseSlab.position.y=-.75;baseSlab.receiveShadow=true;scene.add(baseSlab);
const tG=new THREE.BoxGeometry(tileSize-.08,.15,tileSize-.08);
const tM1=new THREE.MeshLambertMaterial({color:0x55a035}),tM2=new THREE.MeshLambertMaterial({color:0x3d7825});
for(let i=0;i<PLATE_DIVS;i++)for(let j=0;j<PLATE_DIVS;j++){
  const t=new THREE.Mesh(tG,(i+j)%2===0?tM1:tM2);
  t.position.set(-PLATE_SIZE/2+tileSize*i+tileSize/2,.08,-PLATE_SIZE/2+tileSize*j+tileSize/2);
  t.receiveShadow=true;scene.add(t);
}
const edgeMat=new THREE.MeshLambertMaterial({color:0x224410});
[[0,PLATE_SIZE/2+.5,PLATE_SIZE+2,1],[0,-PLATE_SIZE/2-.5,PLATE_SIZE+2,1],
 [PLATE_SIZE/2+.5,0,1,PLATE_SIZE+2],[-PLATE_SIZE/2-.5,0,1,PLATE_SIZE+2]].forEach(([x,z,w,d])=>{
  const e=new THREE.Mesh(new THREE.BoxGeometry(w,.9,d),edgeMat);e.position.set(x,.2,z);scene.add(e);
});

const platformDefs=[
  {x:-10,y:3,z:-10,w:7,d:7,c:0xcc3322},{x:10,y:3,z:-10,w:7,d:7,c:0x2233cc},
  {x:0,y:5,z:12,w:9,d:5,c:0xcc9911},{x:-18,y:4,z:5,w:6,d:6,c:0x22aa44},
  {x:18,y:4,z:5,w:6,d:6,c:0xaa22aa},{x:0,y:9,z:-18,w:8,d:8,c:0xdd6600},
  {x:-14,y:7,z:-18,w:5,d:5,c:0x0099cc},{x:14,y:7,z:-18,w:5,d:5,c:0xcc0066},
  {x:0,y:13,z:0,w:6,d:6,c:0xffcc00},{x:-8,y:6,z:18,w:4,d:4,c:0xff44aa},
  {x:8,y:6,z:18,w:4,d:4,c:0x44ffaa},
];
const platforms=platformDefs.map(p=>{
  const m=new THREE.Mesh(new THREE.BoxGeometry(p.w,1.2,p.d),new THREE.MeshLambertMaterial({color:p.c}));
  m.position.set(p.x,p.y,p.z);m.castShadow=true;m.receiveShadow=true;scene.add(m);
  return{...p,h:1.2};
});

[[-25,5],[25,5],[-25,-22],[25,-22],[0,-30],[0,28],[-35,0],[35,0]].forEach(([x,z])=>{
  const g=new THREE.Group();
  const tk=new THREE.Mesh(new THREE.CylinderGeometry(.35,.5,6,9),new THREE.MeshLambertMaterial({color:0x7a4a1e}));
  tk.position.y=3;tk.castShadow=true;
  const lv=new THREE.Mesh(new THREE.SphereGeometry(3.5,8,6),new THREE.MeshLambertMaterial({color:0x1e8b3a}));
  lv.position.y=8;lv.castShadow=true;
  g.add(tk,lv);g.position.set(x,0,z);scene.add(g);
});

const vfxPool=[];
function spawnJumpRing(x,y,z){
  const ring=new THREE.Mesh(new THREE.RingGeometry(.1,.35,24),new THREE.MeshBasicMaterial({color:0x88ffcc,transparent:true,opacity:.85,side:THREE.DoubleSide}));
  ring.rotation.x=-Math.PI/2;ring.position.set(x,y+.05,z);scene.add(ring);
  vfxPool.push({mesh:ring,age:0,maxAge:.45});
  for(let i=0;i<8;i++){
    const a=(i/8)*Math.PI*2,p=new THREE.Mesh(new THREE.SphereGeometry(.07,4,4),new THREE.MeshBasicMaterial({color:0xccffaa,transparent:true,opacity:.9}));
    p.position.set(x,y+.1,z);scene.add(p);const sp=2.5+Math.random()*1.5;
    vfxPool.push({mesh:p,age:0,maxAge:.35,vx:Math.cos(a)*sp,vy:2+Math.random()*2,vz:Math.sin(a)*sp,isDust:true});
  }
}
function spawnLandPuff(x,y,z){
  for(let i=0;i<6;i++){
    const a=(i/6)*Math.PI*2,p=new THREE.Mesh(new THREE.SphereGeometry(.09,4,4),new THREE.MeshBasicMaterial({color:0xffffff,transparent:true,opacity:.7}));
    p.position.set(x,y+.08,z);scene.add(p);const sp=1.5+Math.random();
    vfxPool.push({mesh:p,age:0,maxAge:.28,vx:Math.cos(a)*sp,vy:1,vz:Math.sin(a)*sp,isDust:true});
  }
}
function updateVFX(dt){
  for(let i=vfxPool.length-1;i>=0;i--){
    const v=vfxPool[i];v.age+=dt;const t=v.age/v.maxAge;
    if(v.isDust){v.mesh.position.x+=v.vx*dt;v.mesh.position.y+=v.vy*dt;v.vy-=12*dt;v.mesh.position.z+=v.vz*dt;v.mesh.material.opacity=.9*(1-t);v.mesh.scale.setScalar(1-t*.5);}
    else{v.mesh.scale.setScalar(1+t*4);v.mesh.material.opacity=.85*(1-t);}
    if(v.age>=v.maxAge){scene.remove(v.mesh);vfxPool.splice(i,1);}
  }
}

function makeNameTex(name){
  const c=document.createElement('canvas');c.width=256;c.height=64;
  const ctx=c.getContext('2d');ctx.clearRect(0,0,256,64);
  ctx.fillStyle='rgba(0,0,0,0.65)';
  if(ctx.roundRect)ctx.roundRect(2,2,252,60,10);else ctx.rect(2,2,252,60);
  ctx.fill();ctx.font='bold 26px Courier New';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillStyle='#00ff88';ctx.fillText(name.substring(0,14),128,32);
  return new THREE.CanvasTexture(c);
}

function buildMonkey(color){
  const g=new THREE.Group();
  const mat=new THREE.MeshLambertMaterial({color});
  const fM=new THREE.MeshLambertMaterial({color:0xffb07a});
  const eM=new THREE.MeshLambertMaterial({color:0x111111});
  const wM=new THREE.MeshLambertMaterial({color:0xffffff});
  const dM=new THREE.MeshLambertMaterial({color:0x331100});
  const bM=new THREE.MeshLambertMaterial({color:0x220800});
  const body=new THREE.Mesh(new THREE.SphereGeometry(.44,12,9),mat);
  body.scale.y=1.18;body.position.y=.82;body.castShadow=true;g.add(body);
  const hG=new THREE.Group();hG.position.y=1.54;
  hG.add(Object.assign(new THREE.Mesh(new THREE.SphereGeometry(.36,12,10),mat),{castShadow:true}));
  const sn=new THREE.Mesh(new THREE.SphereGeometry(.2,10,8),fM);sn.scale.set(1.1,.72,.88);sn.position.set(0,-.04,.3);hG.add(sn);
  [[-.07,-.01,.46],[.07,-.01,.46]].forEach(([x,y,z])=>{const n=new THREE.Mesh(new THREE.SphereGeometry(.045,6,5),dM);n.position.set(x,y,z);hG.add(n);});
  [-.12,.12].forEach((dx,i)=>{
    const ew=new THREE.Mesh(new THREE.SphereGeometry(.085,8,7),wM);ew.position.set(dx,.1,.3);hG.add(ew);
    const ep=new THREE.Mesh(new THREE.SphereGeometry(.058,8,7),eM);ep.position.set(dx,.1,.355);hG.add(ep);
    const br=new THREE.Mesh(new THREE.BoxGeometry(.11,.03,.04),bM);br.position.set(dx,.21,.335);br.rotation.z=i===0?.25:-.25;hG.add(br);
  });
  [-1,1].forEach(s=>{
    const ear=new THREE.Mesh(new THREE.SphereGeometry(.12,8,6),mat);ear.position.set(s*.36,.1,0);hG.add(ear);
    const ei=new THREE.Mesh(new THREE.SphereGeometry(.07,7,5),fM);ei.position.set(s*.42,.1,.04);hG.add(ei);
  });
  g.add(hG);
  function makeArm(s){
    const ag=new THREE.Group();ag.position.set(s*.48,.9,.02);ag.rotation.z=s*.32;
    const sh=new THREE.Group();
    sh.add(Object.assign(new THREE.Mesh(new THREE.CylinderGeometry(.1,.09,.55,8),mat),{castShadow:true,position:{y:-.28}}));
    const el=new THREE.Group();el.position.y=-.56;
    el.add(Object.assign(new THREE.Mesh(new THREE.CylinderGeometry(.08,.07,.5,8),mat),{castShadow:true,position:{y:-.25}}));
    el.add(Object.assign(new THREE.Mesh(new THREE.SphereGeometry(.1,8,6),fM),{position:{y:-.52}}));
    sh.add(el);ag.add(sh);ag.userData.shoulder=sh;ag.userData.elbow=el;return ag;
  }
  function makeLeg(s){
    const lg=new THREE.Group();lg.position.set(s*.21,.42,0);
    const hip=new THREE.Group();
    hip.add(Object.assign(new THREE.Mesh(new THREE.CylinderGeometry(.11,.1,.52,8),mat),{castShadow:true,position:{y:-.26}}));
    const kn=new THREE.Group();kn.position.y=-.53;
    kn.add(Object.assign(new THREE.Mesh(new THREE.CylinderGeometry(.09,.08,.46,8),mat),{castShadow:true,position:{y:-.23}}));
    const fo=new THREE.Mesh(new THREE.BoxGeometry(.18,.1,.3),mat);fo.position.set(0,-.5,.07);kn.add(fo);
    hip.add(kn);lg.add(hip);lg.userData.hip=hip;lg.userData.knee=kn;return lg;
  }
  const aL=makeArm(-1),aR=makeArm(1),lL=makeLeg(-1),lR=makeLeg(1);
  g.add(aL,aR,lL,lR);
  const tailG=new THREE.Group();tailG.position.set(0,.7,-.4);
  for(let i=0;i<7;i++){const seg=new THREE.Mesh(new THREE.SphereGeometry(.075-i*.007,6,5),mat);const a=(i/6)*Math.PI*.9-.4;seg.position.set(0,Math.sin(a)*.32*i*.38,-Math.cos(a)*.14*i);tailG.add(seg);}
  g.add(tailG);
  const sp=new THREE.Sprite(new THREE.SpriteMaterial({map:makeNameTex('Player'),transparent:true,depthTest:false}));
  sp.scale.set(2.4,.58,1);sp.position.y=2.4;g.add(sp);
  g.userData={hG,aL,aR,lL,lR,tailG,sp,walkPhase:Math.random()*Math.PI*2};
  return g;
}
function setName(mk,name){
  const sp=mk.userData.sp;
  sp.material.map.dispose();sp.material.map=makeNameTex(name);sp.material.needsUpdate=true;
}
function animateMonkey(mk,moving,inAir,dt){
  const d=mk.userData;
  if(moving)d.walkPhase+=dt*9;
  const sw=moving?Math.sin(d.walkPhase)*.6:0;
  if(inAir){d.aL.userData.shoulder.rotation.x=-1.1;d.aR.userData.shoulder.rotation.x=-1.1;d.lL.userData.hip.rotation.x=.55;d.lR.userData.hip.rotation.x=.55;d.lL.userData.knee.rotation.x=-.5;d.lR.userData.knee.rotation.x=-.5;}
  else{d.aL.userData.shoulder.rotation.x=-sw;d.aR.userData.shoulder.rotation.x=sw;d.lL.userData.hip.rotation.x=sw;d.lR.userData.hip.rotation.x=-sw;d.lL.userData.knee.rotation.x=Math.max(0,-sw)*.45;d.lR.userData.knee.rotation.x=Math.max(0,sw)*.45;}
  if(moving&&!inAir)mk.position.y+=Math.abs(Math.sin(d.walkPhase))*.018;
  d.tailG.rotation.y=Math.sin(Date.now()*.0018)*.45;d.tailG.rotation.x=Math.sin(Date.now()*.0012)*.15;
}

const COLORS=[0xff5500,0xff2233,0x2255ff,0x22cc44,0xcc22cc,0xffcc00,0x00ccff,0xff8800,0x44ffbb,0xff44bb];
const myColor=COLORS[Math.floor(Math.random()*COLORS.length)];
const player={pos:new THREE.Vector3(0,1.8,0),vel:new THREE.Vector3(),yaw:0,pitch:.25,onGround:false,wasOnGround:false,name:'Monkey',color:myColor,id:null,moving:false,jumpBufferTime:0,coyoteTime:0,canMove:false};
const localMonkey=buildMonkey(player.color);
scene.add(localMonkey);

const remotes={};
function spawnRemote(id,data){
  if(remotes[id])return;
  const m=buildMonkey(data.color||0xff6600);
  setName(m,data.name||'Player');
  m.position.set(data.x||0,data.y||0,data.z||0);
  scene.add(m);
  remotes[id]={monkey:m,name:data.name||'Player',color:data.color||0xff6600,prevX:data.x||0,prevZ:data.z||0,moving:false,inAir:false};
}
function removeRemote(id){if(remotes[id]){scene.remove(remotes[id].monkey);delete remotes[id];}}
function moveRemote(id,data){
  if(!remotes[id]){spawnRemote(id,data);return;}
  const r=remotes[id];
  const dx=(data.x||0)-r.prevX,dz=(data.z||0)-r.prevZ;
  r.moving=(dx*dx+dz*dz)>.0002;r.inAir=(data.y||0)>.35;
  r.prevX=data.x||0;r.prevZ=data.z||0;
  r.monkey.position.set(data.x||0,data.y||0,data.z||0);
  r.monkey.rotation.y=(data.yaw||0)+Math.PI;
  if(data.name&&data.name!==r.name){setName(r.monkey,data.name);r.name=data.name;}
}

const keys={};
window.addEventListener('keydown',e=>{
  if(e.code==='Space')e.preventDefault();
  keys[e.code]=true;
  if(e.code==='KeyT'&&document.getElementById('hud').style.display!=='none'){e.preventDefault();openChat();}
  if(e.code==='Escape'){if(chatOpen){closeChat();return;}if(document.getElementById('hud').style.display!=='none'){document.exitPointerLock();showMenu();}}
});
window.addEventListener('keyup',e=>keys[e.code]=false);
let rightDown=false,mdx=0,mdy=0;
canvas.addEventListener('contextmenu',e=>e.preventDefault());
canvas.addEventListener('mousedown',e=>{if(e.button===2)rightDown=true;});
window.addEventListener('mouseup',e=>{if(e.button===2)rightDown=false;});
window.addEventListener('mousemove',e=>{if(rightDown&&!chatOpen&&document.getElementById('hud').style.display!=='none'){mdx+=e.movementX||0;mdy+=e.movementY||0;}});
canvas.addEventListener('click',()=>{if(!chatOpen&&document.getElementById('hud').style.display!=='none')canvas.requestPointerLock();});
let locked=false;
document.addEventListener('pointerlockchange',()=>locked=!!document.pointerLockElement);
document.addEventListener('mousemove',e=>{if(locked&&!chatOpen&&document.getElementById('hud').style.display!=='none'){mdx+=e.movementX||0;mdy+=e.movementY||0;}});

const joyBase=document.getElementById('joy-base'),joyStick=document.getElementById('joy-stick');
const joy={active:false,id:-1,cx:0,cy:0,dx:0,dy:0,MAX:45};
const look={active:false,id:-1,lx:0,ly:0};
let mobileJump=false;
const joyZone=document.getElementById('joy-zone'),lookZone=document.getElementById('look-zone'),jumpBtn=document.getElementById('jump-btn');
function showJoy(x,y){joyBase.style.left=x+'px';joyBase.style.top=y+'px';joyBase.style.display='block';joyStick.style.left=x+'px';joyStick.style.top=y+'px';joyStick.style.display='block';}
function hideJoy(){joyBase.style.display='none';joyStick.style.display='none';joy.active=false;joy.dx=0;joy.dy=0;}
function updateJoy(x,y){let dx=x-joy.cx,dy=y-joy.cy;const d=Math.sqrt(dx*dx+dy*dy);if(d>joy.MAX){dx=dx/d*joy.MAX;dy=dy/d*joy.MAX;}joy.dx=dx/joy.MAX;joy.dy=dy/joy.MAX;joyStick.style.left=(joy.cx+dx)+'px';joyStick.style.top=(joy.cy+dy)+'px';}
joyZone.addEventListener('touchstart',e=>{e.preventDefault();for(const t of e.changedTouches){if(!joy.active){joy.active=true;joy.id=t.identifier;joy.cx=t.clientX;joy.cy=t.clientY;showJoy(t.clientX,t.clientY);}}},{passive:false});
window.addEventListener('touchmove',e=>{e.preventDefault();for(const t of e.changedTouches){if(joy.active&&t.identifier===joy.id)updateJoy(t.clientX,t.clientY);if(look.active&&t.identifier===look.id&&!chatOpen){mdx+=(t.clientX-look.lx)*.9;mdy+=(t.clientY-look.ly)*.9;look.lx=t.clientX;look.ly=t.clientY;}}},{passive:false});
window.addEventListener('touchend',e=>{for(const t of e.changedTouches){if(joy.active&&t.identifier===joy.id)hideJoy();if(look.active&&t.identifier===look.id){look.active=false;look.id=-1;}}});
lookZone.addEventListener('touchstart',e=>{e.preventDefault();for(const t of e.changedTouches){if(!look.active&&t.identifier!==joy.id){look.active=true;look.id=t.identifier;look.lx=t.clientX;look.ly=t.clientY;}}},{passive:false});
jumpBtn.addEventListener('touchstart',e=>{e.preventDefault();mobileJump=true;jumpBtn.classList.add('pressed');},{passive:false});
jumpBtn.addEventListener('touchend',e=>{e.preventDefault();jumpBtn.classList.remove('pressed');},{passive:false});
jumpBtn.addEventListener('mousedown',()=>{mobileJump=true;jumpBtn.classList.add('pressed');});
jumpBtn.addEventListener('mouseup',()=>jumpBtn.classList.remove('pressed'));

let chatOpen=false,unread=0;
const chatWrap=document.getElementById('chat-wrap'),chatInput=document.getElementById('chat-input');
const chatMsgs=document.getElementById('chat-messages'),chatToggle=document.getElementById('chat-toggle');
const chatUnread=document.getElementById('chat-unread');
function openChat(){chatOpen=true;chatWrap.style.pointerEvents='all';chatInput.focus();document.exitPointerLock();unread=0;chatUnread.style.display='none';chatToggle.style.background='rgba(0,80,30,0.88)';}
function closeChat(){chatOpen=false;chatWrap.style.pointerEvents='none';chatInput.blur();chatToggle.style.background='rgba(0,28,0,0.88)';}
function toggleChat(){chatOpen?closeChat():openChat();}
function addMsg(name,text,sys){
  const d=document.createElement('div');d.className='chat-msg'+(sys?' sys':'');
  d.innerHTML=sys?text:`<span class="cn">${name.substring(0,14)}</span>: ${text.substring(0,80)}`;
  chatMsgs.appendChild(d);chatMsgs.scrollTop=chatMsgs.scrollHeight;
  while(chatMsgs.children.length>40)chatMsgs.removeChild(chatMsgs.firstChild);
  if(!chatOpen&&!sys){unread++;chatUnread.style.display='flex';chatUnread.textContent=unread>9?'9+':unread;}
  if(!chatOpen)setTimeout(()=>{if(d.parentNode)d.style.opacity='0.3';},8000);
}
function sendChat(){
  const txt=chatInput.value.trim();if(!txt)return;
  addMsg(player.name,txt,false);
  if(ws&&ws.readyState===WebSocket.OPEN)ws.send(JSON.stringify({type:'chat',text:txt}));
  chatInput.value='';
}
chatInput.addEventListener('keydown',e=>{e.stopPropagation();if(e.key==='Enter'){sendChat();if(!isMobile)closeChat();}if(e.key==='Escape')closeChat();});
document.getElementById('chat-send').addEventListener('click',()=>{sendChat();if(!isMobile)closeChat();});
chatToggle.addEventListener('click',toggleChat);
chatToggle.addEventListener('touchend',e=>{e.preventDefault();toggleChat();},{passive:false});

const GRAVITY=-22,SPEED=9,JUMP_VEL=11,BHOP=1.18,COYOTE=.12,JBUF=.12;
function resolveGround(pos,vel){
  let landed=false;const hp=PLATE_SIZE/2;
  if(pos.x>-hp&&pos.x<hp&&pos.z>-hp&&pos.z<hp&&pos.y<.01){pos.y=0;landed=true;}
  for(const p of platforms){const hw=p.w/2,hd=p.d/2,top=p.y+p.h/2;
    if(pos.x>p.x-hw&&pos.x<p.x+hw&&pos.z>p.z-hd&&pos.z<p.z+hd&&pos.y>=top-.2&&pos.y<=top+.9&&vel.y<=0){pos.y=top;landed=true;}}
  if(pos.y<-25){pos.set(0,3,0);vel.set(0,0,0);}
  return landed;
}

function showStatus(msg,err){
  const el=document.getElementById('status');el.textContent=msg;
  el.style.color=err?'#ff5555':'#00ff44';el.style.opacity='1';
  clearTimeout(el._t);el._t=setTimeout(()=>el.style.opacity='0',4000);
}
function showMenu(){
  document.body.classList.remove('ingame');player.canMove=false;chatOpen=false;
  document.getElementById('menu-overlay').style.display='flex';
  document.getElementById('hud').style.display='none';
  document.getElementById('mobile-controls').style.display='none';
  document.getElementById('chat-wrap').style.display='none';
  chatToggle.style.display='none';document.getElementById('menu-btn').style.display='none';
}
function hideMenu(){
  document.body.classList.add('ingame');player.canMove=true;
  document.getElementById('menu-overlay').style.display='none';
  document.getElementById('hud').style.display='block';
  document.getElementById('chat-wrap').style.display='block';
  document.getElementById('menu-btn').style.display='block';
  if(isMobile){document.getElementById('mobile-controls').style.display='block';chatToggle.style.display='flex';}
}
document.getElementById('menu-btn').addEventListener('click',()=>{document.exitPointerLock();showMenu();});
document.getElementById('menu-btn').addEventListener('touchend',e=>{e.preventDefault();showMenu();},{passive:false});

let ws=null,currentLobby='public',sendTimer=0,retries=0;

function enterGame(lobby){
  player.name=document.getElementById('nameInput').value.trim()||'Monkey';
  setName(localMonkey,player.name);
  currentLobby=lobby;retries=0;
  hideMenu();
  connect();
}

function connect(){
  showStatus('Connecting...');
  if(ws){const old=ws;ws=null;old.onopen=old.onmessage=old.onclose=old.onerror=null;try{old.close();}catch(e){}}
  let sock;
  try{sock=new WebSocket(WS_SERVER);}catch(e){showStatus('Bad server URL',true);return;}
  const timer=setTimeout(()=>{
    sock.onopen=sock.onclose=sock.onerror=null;try{sock.close();}catch(e){}
    showStatus('Server offline',true);
  },7000);
  sock.onopen=()=>{
    clearTimeout(timer);ws=sock;retries=0;
    ws.send(JSON.stringify({type:'join',lobby:currentLobby,name:player.name,color:player.color}));
    showStatus('Connected ‚úì');
  };
  sock.onmessage=e=>{
    let m;try{m=JSON.parse(e.data);}catch{return;}
    switch(m.type){
      case 'welcome':
        player.id=m.id;
        document.getElementById('lcode').textContent='Lobby: '+(currentLobby==='public'?'PUBLIC':currentLobby.toUpperCase());
        break;
      case 'state':
        Object.keys(remotes).forEach(id=>{if(!m.players[id])removeRemote(id);});
        Object.entries(m.players).forEach(([id,d])=>{if(id!==player.id)moveRemote(id,d);});
        document.getElementById('pcount').textContent='Players: '+Object.keys(m.players).length;
        break;
      case 'player_join':if(m.id!==player.id){spawnRemote(m.id,m);addMsg('','‚ö° '+m.name+' joined',true);}break;
      case 'player_leave':removeRemote(m.id);addMsg('','üëã '+(m.name||'Someone')+' left',true);break;
      case 'player_move':if(m.id!==player.id)moveRemote(m.id,m);document.getElementById('pcount').textContent='Players: '+(Object.keys(remotes).length+1);break;
      case 'chat':if(m.id!==player.id)addMsg(m.name,m.text,false);break;
    }
  };
  sock.onclose=()=>{
    clearTimeout(timer);if(sock===ws)ws=null;
    if(document.getElementById('hud').style.display==='none')return;
    retries++;
    if(retries<=4){const delay=Math.min(1500*retries,8000);showStatus('Reconnecting ('+retries+'/4)...');setTimeout(connect,delay);}
    else{showStatus('Server offline ‚Äî solo mode',true);}
  };
  sock.onerror=()=>{};
}

function sendMove(){
  if(!ws||ws.readyState!==WebSocket.OPEN)return;
  ws.send(JSON.stringify({type:'move',x:player.pos.x,y:player.pos.y,z:player.pos.z,yaw:player.yaw,name:player.name}));
}

document.getElementById('joinPublicBtn').addEventListener('click',()=>enterGame('public'));
document.getElementById('hostBtn').addEventListener('click',()=>{
  const box=document.getElementById('host-box');
  const open=box.style.display==='block';
  box.style.display=open?'none':'block';
  if(!open){const code=Math.random().toString(36).substring(2,8).toUpperCase();document.getElementById('generatedCode').value=code;}
});
document.getElementById('startHostBtn').addEventListener('click',()=>{
  const code=document.getElementById('generatedCode').value.trim();
  if(code)enterGame(code.toLowerCase());
});
document.getElementById('joinPrivBtn').addEventListener('click',()=>{
  const code=document.getElementById('codeInput').value.trim().toUpperCase();
  if(!code){showStatus('Enter a code first!',true);return;}
  enterGame(code.toLowerCase());
});

(function ping(){
  const el=document.getElementById('srv-status');
  try{
    const p=new WebSocket(WS_SERVER);
    const t=setTimeout(()=>{p.onclose=p.onerror=null;try{p.close();}catch(e){}el.textContent='üî¥ Server offline';el.style.color='#ff5555';},5000);
    p.onopen=()=>{clearTimeout(t);el.textContent='üü¢ Server online';el.style.color='#00ff44';try{p.close();}catch(e){}};
    p.onerror=()=>{clearTimeout(t);el.textContent='üî¥ Server offline';el.style.color='#ff5555';};
  }catch(e){el.textContent='üî¥ Server unreachable';el.style.color='#ff5555';}
})();

const clock=new THREE.Clock();
function animate(){
  requestAnimationFrame(animate);
  const dt=Math.min(clock.getDelta(),.05);
  const inGame=document.getElementById('hud').style.display!=='none';
  if(inGame){
    if(mdx||mdy){player.yaw-=mdx*.0022;player.pitch=Math.max(-.45,Math.min(.85,player.pitch-mdy*.0022));mdx=0;mdy=0;}
    if(player.canMove&&!chatOpen){
      const md=new THREE.Vector3();
      if(keys['KeyW']||keys['ArrowUp'])md.z-=1;if(keys['KeyS']||keys['ArrowDown'])md.z+=1;
      if(keys['KeyA']||keys['ArrowLeft'])md.x-=1;if(keys['KeyD']||keys['ArrowRight'])md.x+=1;
      if(joy.active){md.z+=joy.dy;md.x+=joy.dx;}
      if(md.length()>1)md.normalize();
      player.moving=md.lengthSq()>.01;
      const fwd=new THREE.Vector3(-Math.sin(player.yaw),0,-Math.cos(player.yaw));
      const rgt=new THREE.Vector3(Math.cos(player.yaw),0,-Math.sin(player.yaw));
      const mv=fwd.multiplyScalar(-md.z).add(rgt.multiplyScalar(md.x));
      if(player.wasOnGround&&!player.onGround)player.coyoteTime=COYOTE;
      else player.coyoteTime=Math.max(0,player.coyoteTime-dt);
      const wj=keys['Space']||mobileJump;
      if(wj)player.jumpBufferTime=JBUF;else player.jumpBufferTime=Math.max(0,player.jumpBufferTime-dt);
      mobileJump=false;
      if((player.onGround||player.coyoteTime>0)&&player.jumpBufferTime>0){
        const hs=Math.sqrt(player.vel.x**2+player.vel.z**2);
        player.vel.y=JUMP_VEL;player.onGround=false;player.coyoteTime=0;player.jumpBufferTime=0;
        if(hs>.5){player.vel.x*=BHOP;player.vel.z*=BHOP;const mx=SPEED*2.5,ns=Math.sqrt(player.vel.x**2+player.vel.z**2);if(ns>mx){player.vel.x=player.vel.x/ns*mx;player.vel.z=player.vel.z/ns*mx;}}
        spawnJumpRing(player.pos.x,player.pos.y,player.pos.z);
      }
      if(player.onGround){player.vel.x=mv.x*SPEED;player.vel.z=mv.z*SPEED;}
      else{player.vel.x+=mv.x*SPEED*dt*3.5;player.vel.z+=mv.z*SPEED*dt*3.5;player.vel.x*=.98;player.vel.z*=.98;}
      if(!player.onGround)player.vel.y+=GRAVITY*dt;
      player.pos.x+=player.vel.x*dt;player.pos.y+=player.vel.y*dt;player.pos.z+=player.vel.z*dt;
      player.pos.x=Math.max(-60,Math.min(60,player.pos.x));player.pos.z=Math.max(-60,Math.min(60,player.pos.z));
      player.wasOnGround=player.onGround;
      player.onGround=resolveGround(player.pos,player.vel);
      if(player.onGround&&player.vel.y<0){if(player.vel.y<-4)spawnLandPuff(player.pos.x,player.pos.y,player.pos.z);player.vel.y=0;}
    }
    localMonkey.position.set(player.pos.x,player.pos.y,player.pos.z);
    localMonkey.rotation.y=player.yaw+Math.PI;
    animateMonkey(localMonkey,player.moving,!player.onGround,dt);
    const cx=player.pos.x+Math.sin(player.yaw)*CAM_DIST;
    const cz=player.pos.z+Math.cos(player.yaw)*CAM_DIST;
    camera.position.set(cx,player.pos.y+CAM_HEIGHT+player.pitch*2,cz);
    camera.lookAt(player.pos.x,player.pos.y+1.55,player.pos.z);
    updateVFX(dt);
    Object.values(remotes).forEach(r=>animateMonkey(r.monkey,r.moving,r.inAir,dt));
    sendTimer+=dt;if(sendTimer>.05){sendMove();sendTimer=0;}
  }
  renderer.render(scene,camera);
}
window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});
animate();
</script>
</body>
</html>
