<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="mobile-web-app-capable" content="yes"/>
<title>üêí Gorilla Tag Online</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bangers&family=Nunito:wght@400;600;700;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bark:#5c3317;--banana:#f5c842;--orange:#ff6b35;
  --cream:#fdf6e3;--dark:#0d1f0d;--leaf:#2d6a2d;
}
html,body{
  background:var(--dark);font-family:'Nunito',sans-serif;
  color:var(--cream);overflow:hidden;height:100%;width:100%;position:fixed;
}
#canvas{position:fixed;inset:0;display:block;touch-action:none;}

/* ===== SCREENS ===== */
.screen{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  z-index:200;transition:opacity .3s,transform .3s;
}
.screen.hidden{opacity:0;pointer-events:none;transform:scale(.97);}

/* ===== MENU ===== */
#menuScreen{background:radial-gradient(ellipse at 50% 30%,#1f4a1f,#0d1f0d);}
.menu-card{
  background:linear-gradient(145deg,rgba(44,26,15,.97),rgba(26,44,15,.97));
  border:2px solid rgba(92,51,23,.8);border-radius:24px;
  padding:28px 24px;width:min(420px,96vw);
  box-shadow:0 0 60px rgba(90,50,20,.4),inset 0 1px 0 rgba(255,255,255,.05);
  max-height:96vh;overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
.logo{
  font-family:'Bangers',cursive;font-size:clamp(2rem,8vw,3rem);text-align:center;
  background:linear-gradient(135deg,var(--banana),var(--orange));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  letter-spacing:3px;margin-bottom:3px;
}
.logo-sub{text-align:center;font-size:.75rem;color:rgba(255,255,255,.35);margin-bottom:22px;letter-spacing:1px;}
.flabel{font-size:.68rem;font-weight:700;letter-spacing:1px;color:rgba(255,255,255,.4);text-transform:uppercase;margin-bottom:5px;}
input[type=text]{
  width:100%;padding:12px 14px;background:rgba(0,0,0,.35);
  border:1.5px solid rgba(255,255,255,.1);border-radius:12px;
  color:var(--cream);font-family:'Nunito',sans-serif;font-size:1rem;font-weight:600;
  outline:none;transition:border-color .2s;margin-bottom:13px;
  -webkit-appearance:none;
}
input[type=text]:focus{border-color:var(--banana);}
input[type=color]{
  width:100%;height:48px;padding:4px 8px;background:rgba(0,0,0,.35);
  border:1.5px solid rgba(255,255,255,.1);border-radius:12px;cursor:pointer;
  margin-bottom:13px;
}
.btn{
  width:100%;padding:13px;border:none;border-radius:14px;
  font-family:'Bangers',cursive;font-size:1.2rem;letter-spacing:2px;
  cursor:pointer;transition:transform .1s,filter .1s;user-select:none;
  -webkit-tap-highlight-color:transparent;
}
.btn:active{transform:scale(.94);filter:brightness(1.15);}
.btn-primary{background:linear-gradient(135deg,var(--banana),var(--orange));color:#2a1500;}
.btn-secondary{background:rgba(255,255,255,.08);color:var(--cream);border:1.5px solid rgba(255,255,255,.13);}
.btn-danger{background:rgba(200,50,50,.2);color:#ff8080;border:1.5px solid rgba(200,50,50,.3);}
.spacer{height:10px;}
.tab-btns{display:flex;gap:7px;margin-bottom:13px;}
.tab-btn{
  flex:1;padding:9px 4px;background:rgba(255,255,255,.05);
  border:1.5px solid rgba(255,255,255,.1);border-radius:10px;
  color:rgba(255,255,255,.5);font-family:'Nunito',sans-serif;
  font-size:.78rem;font-weight:700;cursor:pointer;transition:all .15s;
  -webkit-tap-highlight-color:transparent;
}
.tab-btn.active{background:rgba(245,200,66,.13);border-color:var(--banana);color:var(--banana);}
.tab-panel{display:none;}
.tab-panel.active{display:block;}
.lobby-list{max-height:170px;overflow-y:auto;margin-top:10px;-webkit-overflow-scrolling:touch;}
.lobby-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:9px 12px;background:rgba(255,255,255,.05);
  border-radius:10px;margin-bottom:7px;cursor:pointer;
  border:1.5px solid rgba(255,255,255,.07);transition:border-color .15s;
}
.lobby-item:active{border-color:var(--banana);}
.lobby-item-name{font-weight:700;font-size:.88rem;}
.lobby-item-info{font-size:.7rem;color:rgba(255,255,255,.38);}
.lobby-badge{background:var(--leaf);border-radius:6px;padding:2px 8px;font-size:.68rem;font-weight:700;}
.error-msg{
  background:rgba(200,50,50,.2);border:1px solid rgba(200,50,50,.4);
  border-radius:8px;padding:8px 12px;font-size:.78rem;color:#ff8080;
  margin-top:8px;display:none;
}
.conn-bar{
  display:flex;align-items:center;justify-content:center;gap:6px;
  font-size:.7rem;color:rgba(255,255,255,.3);margin:8px 0;
}
.cdot{width:6px;height:6px;border-radius:50%;background:#ff4444;transition:background .3s;}
.cdot.on{background:#44ff88;}

/* ===== ESC MENU ===== */
#escMenu{background:rgba(0,0,0,.82);backdrop-filter:blur(10px);}
.esc-card{
  background:rgba(20,40,20,.97);border:2px solid var(--bark);
  border-radius:20px;padding:30px 26px;width:min(300px,90vw);
  display:flex;flex-direction:column;gap:12px;
}
.esc-title{font-family:'Bangers',cursive;font-size:2rem;text-align:center;color:var(--banana);letter-spacing:2px;}

/* ===== HUD ===== */
#hud{position:fixed;top:0;left:0;right:0;z-index:100;pointer-events:none;display:none;}
#hud.on{display:block;}
.hud-top{display:flex;justify-content:space-between;align-items:flex-start;padding:12px 14px;}
.hud-pill{
  background:rgba(0,0,0,.6);backdrop-filter:blur(6px);
  border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:7px 12px;
}
.hud-code{font-family:'Bangers',cursive;font-size:1.05rem;color:var(--banana);letter-spacing:2px;}
.hud-sub{font-size:.62rem;color:rgba(255,255,255,.38);margin-top:1px;}
#hudPlayers{font-size:.78rem;color:rgba(255,255,255,.65);}

/* ===== MOBILE CONTROLS ===== */
#mobileControls{
  position:fixed;inset:0;pointer-events:none;z-index:90;display:none;
}
#mobileControls.on{display:block;}

/* Left joystick zone ‚Äî bottom-left half */
#joystickZone{
  position:absolute;left:0;bottom:0;
  width:44%;height:52%;
  pointer-events:all;
}
/* Dynamic joystick base */
#joyBase{
  position:absolute;
  width:120px;height:120px;
  background:rgba(255,255,255,.07);
  border:2.5px solid rgba(255,255,255,.22);
  border-radius:50%;
  pointer-events:none;
  opacity:0;transition:opacity .15s;
}
#joyBase.show{opacity:1;}
#joyThumb{
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);
  width:46px;height:46px;
  background:rgba(245,200,66,.75);
  border:2px solid rgba(245,200,66,.95);
  border-radius:50%;
  box-shadow:0 0 14px rgba(245,200,66,.45);
  pointer-events:none;
}

/* Right look zone */
#lookZone{
  position:absolute;right:0;top:0;
  width:56%;height:100%;
  pointer-events:all;
}

/* Action buttons ‚Äî right side stacked */
#actionBtns{
  position:absolute;right:16px;bottom:90px;
  display:flex;flex-direction:column;gap:10px;align-items:center;
  pointer-events:all;
}
.act-btn{
  border:none;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;user-select:none;
  -webkit-tap-highlight-color:transparent;
  transition:transform .1s,filter .1s;
  pointer-events:all;
}
.act-btn:active{transform:scale(.87);filter:brightness(1.25);}

#jumpBtn{
  width:82px;height:82px;
  background:linear-gradient(135deg,#4fc3f7,#0277bd);
  font-family:'Bangers',cursive;font-size:1.1rem;letter-spacing:1px;
  color:#fff;font-weight:700;
  box-shadow:0 4px 20px rgba(2,119,189,.5);
}
#chatBtn{
  width:60px;height:60px;
  background:linear-gradient(135deg,#81c784,#2e7d32);
  font-size:1.3rem;
  box-shadow:0 4px 16px rgba(46,125,50,.4);
}
#menuOpenBtn{
  width:54px;height:54px;
  background:rgba(0,0,0,.55);
  border:1.5px solid rgba(255,255,255,.2);
  font-size:1.1rem;color:rgba(255,255,255,.7);
  box-shadow:0 2px 10px rgba(0,0,0,.4);
}

/* ===== CHAT OVERLAY ===== */
#chatOverlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.78);backdrop-filter:blur(8px);
  z-index:160;display:none;
  flex-direction:column;justify-content:flex-end;
  padding:16px;gap:10px;
}
#chatOverlay.on{display:flex;}
#chatMsgs{
  flex:1;max-height:55vh;overflow-y:auto;
  padding:12px;
  background:rgba(0,0,0,.45);border-radius:14px;
  border:1px solid rgba(255,255,255,.1);
  -webkit-overflow-scrolling:touch;
  scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.15) transparent;
}
.cmsg{font-size:.82rem;margin-bottom:7px;line-height:1.45;animation:cfi .2s ease;}
@keyframes cfi{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:none;}}
.cmsg .sndr{font-weight:800;margin-right:4px;}
.cmsg.sys{color:rgba(255,255,255,.38);font-style:italic;}
.chat-row{display:flex;gap:8px;align-items:center;}
#chatInput{
  flex:1;background:rgba(0,0,0,.6);
  border:1.5px solid rgba(255,255,255,.2);border-radius:14px;
  padding:14px 16px;color:var(--cream);
  font-family:'Nunito',sans-serif;font-size:1rem;font-weight:600;
  outline:none;-webkit-appearance:none;
}
#chatInput:focus{border-color:var(--banana);}
#chatSendBtn{
  background:linear-gradient(135deg,var(--banana),var(--orange));
  border:none;border-radius:14px;padding:14px 18px;
  font-size:1.3rem;color:#2a1500;cursor:pointer;
  -webkit-tap-highlight-color:transparent;
}
#chatCloseBtn{
  background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);
  border-radius:14px;padding:14px 15px;font-size:.95rem;
  color:rgba(255,255,255,.6);cursor:pointer;
  -webkit-tap-highlight-color:transparent;
}

/* Floating chat previews */
#chatPreview{
  position:fixed;bottom:clamp(80px,20vw,110px);
  left:50%;transform:translateX(-50%);
  width:min(340px,88vw);z-index:85;pointer-events:none;display:none;
}
#chatPreview.on{display:block;}
.cprev{
  background:rgba(0,0,0,.7);backdrop-filter:blur(4px);
  border:1px solid rgba(255,255,255,.1);border-radius:10px;
  padding:7px 12px;font-size:.78rem;margin-bottom:5px;
  animation:cfi .2s ease,cfade .5s ease 3.5s forwards;
}
@keyframes cfade{to{opacity:0;transform:translateY(-4px);}}

/* PC crosshair */
#crosshair{
  position:fixed;top:50%;left:50%;
  transform:translate(-50%,-50%);
  width:16px;height:16px;pointer-events:none;z-index:80;display:none;
}
#crosshair.on{display:block;}
#crosshair::before,#crosshair::after{content:'';position:absolute;background:rgba(255,255,255,.55);}
#crosshair::before{width:100%;height:1.5px;top:50%;transform:translateY(-50%);}
#crosshair::after{height:100%;width:1.5px;left:50%;transform:translateX(-50%);}
#hint{
  position:fixed;bottom:14px;right:14px;
  background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.09);
  border-radius:10px;padding:9px 12px;font-size:.67rem;
  color:rgba(255,255,255,.32);z-index:80;pointer-events:none;
  line-height:1.9;display:none;
}
#hint.on{display:block;}
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<!-- =========== MENU =========== -->
<div class="screen" id="menuScreen">
  <div class="menu-card">
    <div class="logo">üêí GORILLA TAG</div>
    <div class="logo-sub">ONLINE MULTIPLAYER</div>

    <div class="flabel">Your Name</div>
    <input type="text" id="playerName" placeholder="MonkeyBro" maxlength="20"/>

    <div class="flabel">Monkey Color</div>
    <input type="color" id="playerColor" value="#8B4513"/>

    <div class="conn-bar">
      <span class="cdot" id="connDot"></span>
      <span id="connText">Connecting‚Ä¶</span>
    </div>
    <div class="spacer"></div>

    <div class="tab-btns">
      <button class="tab-btn active" onclick="switchTab('create')">üåø Create</button>
      <button class="tab-btn" onclick="switchTab('join')">üîó Join</button>
      <button class="tab-btn" onclick="switchTab('browse')">üåç Browse</button>
    </div>

    <div class="tab-panel active" id="tab-create">
      <div class="flabel">Lobby Name</div>
      <input type="text" id="lobbyName" placeholder="My Jungle" maxlength="30"/>
      <label style="display:flex;align-items:center;gap:8px;font-size:.82rem;cursor:pointer;margin-bottom:13px;">
        <input type="checkbox" id="isPrivate" style="width:auto;padding:0;accent-color:var(--banana);"/>
        Private Lobby
      </label>
      <button class="btn btn-primary" onclick="createLobby()">üå¥ Create Lobby</button>
    </div>

    <div class="tab-panel" id="tab-join">
      <div class="flabel">Lobby Code</div>
      <input type="text" id="joinCode" placeholder="ABCDEF" maxlength="6"
        style="text-transform:uppercase;letter-spacing:4px;text-align:center;font-family:'Bangers',cursive;font-size:1.5rem;"/>
      <button class="btn btn-primary" onclick="joinLobbyByCode()">üêí Jump In!</button>
    </div>

    <div class="tab-panel" id="tab-browse">
      <button class="btn btn-secondary" onclick="refreshLobbies()">üîÑ Refresh</button>
      <div class="lobby-list" id="lobbyList">
        <div style="text-align:center;color:rgba(255,255,255,.28);font-size:.8rem;padding:18px;">Hit refresh to load lobbies</div>
      </div>
    </div>

    <div class="error-msg" id="errorMsg"></div>
  </div>
</div>

<!-- =========== ESC MENU =========== -->
<div class="screen hidden" id="escMenu">
  <div class="esc-card">
    <div class="esc-title">‚è∏ PAUSED</div>
    <button class="btn btn-primary" onclick="resumeGame()">‚ñ∂ Resume</button>
    <button class="btn btn-secondary" onclick="copyCode()">üìã Code: <span id="escCode">---</span></button>
    <button class="btn btn-danger" onclick="leaveGame()">üö™ Leave Game</button>
  </div>
</div>

<!-- =========== HUD =========== -->
<div id="hud">
  <div class="hud-top">
    <div class="hud-pill">
      <div class="hud-code" id="hudCode">------</div>
      <div class="hud-sub" id="hudSub"></div>
    </div>
    <div class="hud-pill" id="hudPlayers">üë• 1</div>
  </div>
</div>

<!-- =========== MOBILE CONTROLS =========== -->
<div id="mobileControls">
  <div id="joystickZone">
    <div id="joyBase"><div id="joyThumb"></div></div>
  </div>
  <div id="lookZone"></div>
  <div id="actionBtns">
    <button class="act-btn" id="menuOpenBtn" onclick="openEsc()">‚ò∞</button>
    <button class="act-btn" id="chatBtn" onclick="openChat()">üí¨</button>
    <button class="act-btn" id="jumpBtn">JUMP</button>
  </div>
</div>

<!-- =========== CHAT OVERLAY =========== -->
<div id="chatOverlay">
  <div id="chatMsgs"></div>
  <div class="chat-row">
    <button id="chatCloseBtn" onclick="closeChat()">‚úï</button>
    <input type="text" id="chatInput" placeholder="Say something‚Ä¶" maxlength="200"/>
    <button id="chatSendBtn" onclick="sendChat()">‚û§</button>
  </div>
</div>

<!-- Floating preview bubbles -->
<div id="chatPreview"></div>

<!-- PC overlays -->
<div id="crosshair"></div>
<div id="hint">WASD ‚Äì Move &nbsp;|&nbsp; Space ‚Äì Jump<br/>Mouse ‚Äì Look &nbsp;|&nbsp; Enter ‚Äì Chat &nbsp;|&nbsp; Esc ‚Äì Menu</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// =====================================================
//   CONFIG ‚Äî replace with your deployed server URL
// =====================================================
const SERVER_URL = "wss://packageandsmth-production.up.railway.app";

// =====================================================
//   DEVICE DETECT
// =====================================================
const isMobile = ('ontouchstart' in window) || /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

// =====================================================
//   THREE.JS
// =====================================================
const canvas = document.getElementById("canvas");
const renderer = new THREE.WebGLRenderer({ canvas, antialias: !isMobile });
renderer.setPixelRatio(Math.min(devicePixelRatio, isMobile ? 1.5 : 2));
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.setClearColor(0x87ceeb);

const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x87ceeb, 0.018);

const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 200);
scene.add(new THREE.AmbientLight(0x6a9a6a, 0.8));
const sun = new THREE.DirectionalLight(0xfff5d0, 1.4);
sun.position.set(40, 80, 30);
sun.castShadow = true;
sun.shadow.mapSize.set(1024, 1024);
sun.shadow.camera.left = sun.shadow.camera.bottom = -70;
sun.shadow.camera.right = sun.shadow.camera.top = 70;
sun.shadow.camera.far = 220;
scene.add(sun);

scene.add(new THREE.Mesh(
  new THREE.SphereGeometry(150, 32, 16),
  new THREE.MeshBasicMaterial({ color: 0x87ceeb, side: THREE.BackSide })
));

const gnd = new THREE.Mesh(
  new THREE.PlaneGeometry(200, 200, 30, 30),
  new THREE.MeshLambertMaterial({ color: 0x3a7a1a })
);
gnd.rotation.x = -Math.PI / 2;
gnd.receiveShadow = true;
scene.add(gnd);
const grid = new THREE.GridHelper(200, 40, 0x2a5a0a, 0x2a5a0a);
grid.position.y = 0.01;
scene.add(grid);

// Trees
[[5,5],[-5,8],[10,-3],[-8,-6],[15,10],[-12,4],[3,-12],[-6,15],[18,-8],[-15,-10],
 [7,18],[-4,-16],[12,12],[-10,-13],[20,5],[-18,8],[6,-18],[-7,20],[14,-14],[-16,3]
].forEach(([x,z]) => {
  const tr = new THREE.Mesh(new THREE.CylinderGeometry(.3,.5,3,7), new THREE.MeshLambertMaterial({color:0x5c3317}));
  tr.position.set(x,1.5,z); tr.castShadow=true; scene.add(tr);
  const lv = new THREE.Mesh(new THREE.SphereGeometry(2.5,7,5), new THREE.MeshLambertMaterial({color:0x2d6a2d}));
  lv.position.set(x,5,z); lv.castShadow=true; scene.add(lv);
});

// Platforms
const platforms = [];
function mkPlat(x,y,z,w,h,d,col=0x8B6914){
  const m = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), new THREE.MeshLambertMaterial({color:col}));
  m.position.set(x,y,z); m.castShadow=m.receiveShadow=true; scene.add(m);
  platforms.push({x,y,z,w,h,d});
}
mkPlat(0,.25,0,10,.5,10);
mkPlat(8,2,-5,4,.5,4,0x7a5a10); mkPlat(-8,3,5,5,.5,3,0x6a4a0a);
mkPlat(15,4,0,3,.5,3);           mkPlat(-12,5,-8,4,.5,4,0x7a5a10);
mkPlat(5,6,10,3,.5,5,0x6a4a0a); mkPlat(-3,8,-12,6,.5,3);
mkPlat(0,10,0,4,.5,4,0xb8860b);

for(let i=0;i<12;i++){
  const r = new THREE.Mesh(new THREE.DodecahedronGeometry(.3+Math.random()*.6,0), new THREE.MeshLambertMaterial({color:0x777777}));
  r.position.set((Math.random()-.5)*50,.3,(Math.random()-.5)*50);
  r.rotation.set(Math.random(2),Math.random(2),Math.random(2));
  r.castShadow=true; scene.add(r);
}

// =====================================================
//   MONKEY MESH
// =====================================================
function makeMonkey(hexColor){
  const g = new THREE.Group();
  const c = new THREE.Color(hexColor);
  const M = (geo,col) => new THREE.Mesh(geo, new THREE.MeshLambertMaterial({color:col}));

  const body = M(new THREE.SphereGeometry(.45,8,6), c);
  body.scale.y=1.2; g.add(body);

  const head = M(new THREE.SphereGeometry(.35,8,6), c);
  head.position.y=.75; g.add(head);

  const face = M(new THREE.SphereGeometry(.22,8,6), 0xd2a679);
  face.position.set(0,.72,.2); face.scale.z=.5; g.add(face);

  [-0.1,0.1].forEach(x=>{
    const eye = M(new THREE.SphereGeometry(.04,6,4), 0x111111);
    eye.position.set(x,.8,.32); g.add(eye);
  });
  [-0.55,0.55].forEach(x=>{
    const arm = M(new THREE.CylinderGeometry(.1,.08,.7,6), c);
    arm.position.set(x,0,0); arm.rotation.z=x>0?-.4:.4; g.add(arm);
  });
  [-0.2,0.2].forEach(x=>{
    const leg = M(new THREE.CylinderGeometry(.1,.09,.6,6), c);
    leg.position.set(x,-.6,0); g.add(leg);
  });
  g.castShadow=true;
  return g;
}

function makeTag(name, hexColor){
  const cv = document.createElement("canvas");
  cv.width=256; cv.height=64;
  const ctx = cv.getContext("2d");
  ctx.fillStyle="rgba(0,0,0,0.6)";
  ctx.beginPath();
  if(ctx.roundRect) ctx.roundRect(0,0,256,64,12); else ctx.rect(0,0,256,64);
  ctx.fill();
  ctx.font="bold 28px Nunito,sans-serif";
  ctx.textAlign="center";
  ctx.fillStyle=hexColor;
  ctx.fillText(name.substring(0,14),128,44);
  const spr = new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(cv),transparent:true}));
  spr.scale.set(1.4,.35,1);
  spr.position.y=1.6;
  return spr;
}

// =====================================================
//   GAME STATE
// =====================================================
let ws=null, myId=null, lobbyCode=null;
let isInGame=false, escOpen=false, chatOpen=false, pointerLocked=false;
const remotePlayers={};
let myName="Monkey", myColor="#8B4513";

const pPos = new THREE.Vector3(0,1.5,0);
const pVel = new THREE.Vector3();
let camPitch=0, camYaw=0, onGround=false;
const SPEED=6, JUMP=8, GRAV=-18;
const keys={};

// Local player mesh ‚Äî visible in world, body faces movement dir
let localMesh = null;
let charFaceYaw = 0; // body rotation, independent of camera yaw

// =====================================================
//   JOYSTICK
// =====================================================
const joyState={active:false,tid:null,sx:0,sy:0,dx:0,dy:0};
const lookState={active:false,tid:null,lx:0,ly:0};
let jumpTouching=false;

const jZone = document.getElementById("joystickZone");
const jBase = document.getElementById("joyBase");
const jThumb = document.getElementById("joyThumb");
const lZone = document.getElementById("lookZone");
const JMAX = 50;

jZone.addEventListener("touchstart", e=>{
  e.preventDefault();
  const t=e.changedTouches[0];
  if(joyState.active) return;
  joyState.active=true; joyState.tid=t.identifier;
  joyState.sx=t.clientX; joyState.sy=t.clientY;
  joyState.dx=0; joyState.dy=0;
  const r=jZone.getBoundingClientRect();
  jBase.style.left=(t.clientX-r.left-60)+"px";
  jBase.style.bottom=(r.bottom-t.clientY-60)+"px";
  jBase.style.transform="none";
  jBase.classList.add("show");
},{passive:false});

jZone.addEventListener("touchmove", e=>{
  e.preventDefault();
  for(const t of e.changedTouches){
    if(t.identifier!==joyState.tid) continue;
    const rx=t.clientX-joyState.sx, ry=t.clientY-joyState.sy;
    const dist=Math.hypot(rx,ry);
    const clamped=Math.min(dist,JMAX);
    joyState.dx=dist>3?(clamped/JMAX)*(rx/dist):0;
    joyState.dy=dist>3?(clamped/JMAX)*(ry/dist):0;
    jThumb.style.transform=`translate(calc(-50% + ${joyState.dx*JMAX}px),calc(-50% + ${joyState.dy*JMAX}px))`;
  }
},{passive:false});

function joyEnd(e){
  for(const t of e.changedTouches){
    if(t.identifier===joyState.tid){
      joyState.active=false; joyState.dx=0; joyState.dy=0;
      jThumb.style.transform="translate(-50%,-50%)";
      jBase.classList.remove("show");
    }
  }
}
jZone.addEventListener("touchend",joyEnd,{passive:false});
jZone.addEventListener("touchcancel",joyEnd,{passive:false});

lZone.addEventListener("touchstart",e=>{
  e.preventDefault();
  const t=e.changedTouches[0];
  if(lookState.active) return;
  lookState.active=true; lookState.tid=t.identifier;
  lookState.lx=t.clientX; lookState.ly=t.clientY;
},{passive:false});

lZone.addEventListener("touchmove",e=>{
  e.preventDefault();
  for(const t of e.changedTouches){
    if(t.identifier!==lookState.tid) continue;
    const dx=t.clientX-lookState.lx, dy=t.clientY-lookState.ly;
    camYaw  -= dx * 0.005;
    camPitch -= dy * 0.005;
    camPitch=Math.max(-Math.PI/2+.1,Math.min(Math.PI/2-.1,camPitch));
    lookState.lx=t.clientX; lookState.ly=t.clientY;
  }
},{passive:false});

function lookEnd(e){
  for(const t of e.changedTouches){if(t.identifier===lookState.tid)lookState.active=false;}
}
lZone.addEventListener("touchend",lookEnd,{passive:false});
lZone.addEventListener("touchcancel",lookEnd,{passive:false});

const jumpBtn=document.getElementById("jumpBtn");
jumpBtn.addEventListener("touchstart",e=>{e.preventDefault();jumpTouching=true;},{passive:false});
jumpBtn.addEventListener("touchend",e=>{e.preventDefault();jumpTouching=false;},{passive:false});
jumpBtn.addEventListener("touchcancel",e=>{jumpTouching=false;},{passive:false});

// =====================================================
//   PC KEYBOARD / POINTER LOCK
// =====================================================
document.addEventListener("keydown",e=>{
  keys[e.code]=true;
  if(!isInGame) return;
  if(e.code==="Escape"){
    e.preventDefault();
    if(chatOpen){closeChat();return;}
    escOpen?resumeGame():openEsc();
    return;
  }
  if(e.code==="Enter"&&!escOpen){
    e.preventDefault();
    chatOpen?sendChat():openChat();
  }
  if(e.code==="KeyT"&&!escOpen&&!chatOpen) openChat();
});
document.addEventListener("keyup",e=>{keys[e.code]=false;});

// PC: Right-click drag = free look (Roblox style)
let rightDragging = false;
canvas.addEventListener("mousedown", e => {
  if(e.button === 2 && isInGame && !escOpen && !chatOpen){
    rightDragging = true;
    canvas.requestPointerLock();
  }
  // Left click also locks for convenience
  if(e.button === 0 && isInGame && !escOpen && !chatOpen && !isMobile){
    rightDragging = true;
    canvas.requestPointerLock();
  }
});
canvas.addEventListener("mouseup", e => {
  if(e.button === 2 || e.button === 0){
    rightDragging = false;
    if(document.pointerLockElement === canvas) document.exitPointerLock();
  }
});
canvas.addEventListener("contextmenu", e => e.preventDefault());

document.addEventListener("pointerlockchange",()=>{
  pointerLocked=document.pointerLockElement===canvas;
  if(!pointerLocked) rightDragging=false;
});
document.addEventListener("mousemove",e=>{
  if(!pointerLocked||escOpen||chatOpen) return;
  camYaw  -= e.movementX * 0.003;
  camPitch -= e.movementY * 0.003;
  camPitch=Math.max(-Math.PI/2+.1, Math.min(Math.PI/2-.1, camPitch));
});

// =====================================================
//   PHYSICS
// =====================================================
function groundY(x,z){
  let gy=0;
  platforms.forEach(p=>{
    if(x>=p.x-p.w/2&&x<=p.x+p.w/2&&z>=p.z-p.d/2&&z<=p.z+p.d/2){
      const top=p.y+p.h/2; if(top>gy)gy=top;
    }
  });
  return gy;
}

// =====================================================
//   GAME LOOP
// =====================================================
let lastT=performance.now(), sendT=0;

function loop(){
  requestAnimationFrame(loop);
  const now=performance.now();
  const dt=Math.min((now-lastT)/1000,.05);
  lastT=now;

  if(!isInGame){renderer.render(scene,camera);return;}

  // Camera-relative forward/right (horizontal only)
  const fwd = new THREE.Vector3(-Math.sin(camYaw),0,-Math.cos(camYaw));
  const rgt = new THREE.Vector3(Math.cos(camYaw),0,-Math.sin(camYaw));
  const mv  = new THREE.Vector3();

  // PC
  if(keys["KeyW"]||keys["ArrowUp"])   mv.add(fwd);
  if(keys["KeyS"]||keys["ArrowDown"]) mv.sub(fwd);
  if(keys["KeyA"]||keys["ArrowLeft"]) mv.sub(rgt);
  if(keys["KeyD"]||keys["ArrowRight"])mv.add(rgt);

  // Mobile joystick ‚Äî camera-relative
  if(isMobile){
    if(Math.abs(joyState.dx)>.04||Math.abs(joyState.dy)>.04){
      mv.addScaledVector(fwd,-joyState.dy);
      mv.addScaledVector(rgt, joyState.dx);
    }
  }

  const isMoving = mv.length() > 0.01;

  if(isMoving){
    mv.normalize().multiplyScalar(SPEED);
    pVel.x=mv.x; pVel.z=mv.z;
    // Smoothly rotate character body toward movement direction (Roblox style)
    const targetYaw = Math.atan2(mv.x, mv.z);
    let diff = targetYaw - charFaceYaw;
    // Wrap to [-PI, PI]
    while(diff > Math.PI) diff -= Math.PI*2;
    while(diff < -Math.PI) diff += Math.PI*2;
    charFaceYaw += diff * Math.min(1, dt * 14);
  } else {
    pVel.x*=.83; pVel.z*=.83;
  }

  const gy=groundY(pPos.x,pPos.z);
  onGround=pPos.y<=gy+1.0+.05;

  const doJump=keys["Space"]||(isMobile&&jumpTouching);
  if(doJump&&onGround){pVel.y=JUMP;onGround=false;}

  pVel.y+=GRAV*dt;
  pPos.addScaledVector(pVel,dt);

  if(pPos.y<gy+1.0){pPos.y=gy+1.0; if(pVel.y<0)pVel.y=0;}
  pPos.x=Math.max(-90,Math.min(90,pPos.x));
  pPos.z=Math.max(-90,Math.min(90,pPos.z));

  // Update local player mesh position + body rotation
  if(localMesh){
    localMesh.position.copy(pPos);
    localMesh.rotation.y = charFaceYaw;
    // Bob when moving
    if(isMoving){
      const walkBob = (performance.now()/1000)*8;
      localMesh.position.y = pPos.y + Math.sin(walkBob)*0.07;
    }
  }

  // ---- ROBLOX-STYLE FREE LOOK CAMERA ----
  // Camera orbits freely around player. Moving character doesn't rotate camera.
  // Camera distance and orbit fully controlled by mouse/touch.
  const camDist = 5;
  // Horizontal offset uses camYaw (free look)
  // Vertical offset uses camPitch (clamped)
  const camX = pPos.x + Math.sin(camYaw) * Math.cos(camPitch) * camDist;
  const camY = pPos.y + 1.2 + Math.sin(camPitch) * camDist;
  const camZ = pPos.z + Math.cos(camYaw) * Math.cos(camPitch) * camDist;
  camera.position.set(camX, camY, camZ);
  camera.lookAt(pPos.x, pPos.y + 0.8, pPos.z);

  // Network send
  sendT+=dt;
  if(sendT>.05&&ws&&ws.readyState===1){
    sendT=0;
    ws.send(JSON.stringify({
      type:"move",
      x:+pPos.x.toFixed(3),y:+pPos.y.toFixed(3),z:+pPos.z.toFixed(3),
      rx:+camPitch.toFixed(3),ry:+charFaceYaw.toFixed(3)
    }));
  }

  // Animate remotes
  Object.values(remotePlayers).forEach(rp=>{
    if(!rp.mesh||!rp.target)return;
    rp.mesh.position.lerp(rp.target,.22);
    rp.mesh.rotation.y=rp.tRY||0;
    if(rp.moving){
      rp.wt=(rp.wt||0)+dt*8;
      rp.mesh.position.y+=Math.sin(rp.wt)*.04;
    }
  });

  renderer.render(scene,camera);
}
loop();

window.addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
renderer.setSize(innerWidth,innerHeight);

// =====================================================
//   WEBSOCKET
// =====================================================
function connectWS(){
  try{ ws=new WebSocket(SERVER_URL); }
  catch(e){ setConn(false); return; }
  ws.onopen=()=>setConn(true);
  ws.onclose=()=>{ setConn(false); setTimeout(connectWS,3000); };
  ws.onerror=()=>setConn(false);
  ws.onmessage=e=>{
    let m; try{m=JSON.parse(e.data);}catch{return;}
    handleMsg(m);
  };
}
function setConn(c){
  document.getElementById("connDot").className="cdot"+(c?" on":"");
  document.getElementById("connText").textContent=c?"Connected ‚úì":"Connecting‚Ä¶";
}
function handleMsg(m){
  switch(m.type){
    case"lobby_joined": myId=m.myId||myId; lobbyCode=m.code; enterGame(m); break;
    case"player_joined": addRP(m.player); updPlayers(); break;
    case"player_left":   removeRP(m.id);  updPlayers(); break;
    case"player_move":   moveRP(m);  break;
    case"chat":          addChatMsg(m); break;
    case"lobbies_list":  renderLobbies(m.lobbies); break;
    case"error":         showErr(m.message); break;
  }
}

// =====================================================
//   LOBBY ACTIONS
// =====================================================
function getInfo(){
  return{
    playerName:(document.getElementById("playerName").value.trim()||"Monkey"),
    color:document.getElementById("playerColor").value
  };
}
function createLobby(){
  if(!ws||ws.readyState!==1){showErr("Not connected!");return;}
  const{playerName,color}=getInfo(); myName=playerName; myColor=color;
  ws.send(JSON.stringify({
    type:"create_lobby",playerName,color,
    lobbyName:document.getElementById("lobbyName").value.trim()||"My Jungle",
    isPrivate:document.getElementById("isPrivate").checked
  }));
}
function joinLobbyByCode(code){
  if(!ws||ws.readyState!==1){showErr("Not connected!");return;}
  const{playerName,color}=getInfo(); myName=playerName; myColor=color;
  const c=(code||document.getElementById("joinCode").value.trim()).toUpperCase();
  if(!c){showErr("Enter a code!");return;}
  ws.send(JSON.stringify({type:"join_lobby",code:c,playerName,color}));
}
function refreshLobbies(){
  if(!ws||ws.readyState!==1){showErr("Not connected!");return;}
  ws.send(JSON.stringify({type:"get_lobbies"}));
}
function renderLobbies(list){
  const el=document.getElementById("lobbyList");
  if(!list||!list.length){
    el.innerHTML='<div style="text-align:center;color:rgba(255,255,255,.28);font-size:.8rem;padding:18px;">No public lobbies üåø</div>';
    return;
  }
  el.innerHTML=list.map(l=>`
    <div class="lobby-item" onclick="joinLobbyByCode('${l.code}')">
      <div>
        <div class="lobby-item-name">${eh(l.name)}</div>
        <div class="lobby-item-info">Code: ${l.code}</div>
      </div>
      <span class="lobby-badge">üë•${l.players}</span>
    </div>`).join("");
}

// =====================================================
//   ENTER / LEAVE GAME
// =====================================================
function enterGame(msg){
  isInGame=true;
  document.getElementById("menuScreen").classList.add("hidden");
  document.getElementById("hud").classList.add("on");
  document.getElementById("chatPreview").classList.add("on");
  if(isMobile){
    document.getElementById("mobileControls").classList.add("on");
  } else {
    document.getElementById("crosshair").classList.add("on");
    document.getElementById("hint").classList.add("on");
  }
  document.getElementById("hudCode").textContent=msg.code;
  document.getElementById("escCode").textContent=msg.code;
  document.getElementById("hudSub").textContent=msg.lobbyName||"";

  pPos.set(0,2,0); pVel.set(0,0,0); camYaw=0; camPitch=0; charFaceYaw=0;

  // Create & add local player mesh to scene
  if(localMesh){ scene.remove(localMesh); }
  localMesh = makeMonkey(myColor);
  localMesh.add(makeTag(myName, myColor));
  localMesh.position.copy(pPos);
  scene.add(localMesh);
  (msg.players||[]).forEach(p=>{if(p.id!==myId)addRP(p);});
  updPlayers();
  if(!isMobile)setTimeout(()=>canvas.requestPointerLock(),300);
}
function leaveGame(){
  isInGame=false; escOpen=false; chatOpen=false;
  Object.keys(remotePlayers).forEach(id=>removeRP(id));
  if(localMesh){ scene.remove(localMesh); localMesh=null; }
  document.getElementById("escMenu").classList.add("hidden");
  document.getElementById("menuScreen").classList.remove("hidden");
  document.getElementById("hud").classList.remove("on");
  document.getElementById("chatPreview").classList.remove("on");
  document.getElementById("mobileControls").classList.remove("on");
  document.getElementById("crosshair").classList.remove("on");
  document.getElementById("hint").classList.remove("on");
  document.getElementById("chatOverlay").classList.remove("on");
  document.exitPointerLock();
  if(ws&&ws.readyState===1)ws.close();
  connectWS();
}

// =====================================================
//   REMOTE PLAYERS
// =====================================================
function addRP(data){
  if(remotePlayers[data.id])return;
  const mesh=makeMonkey(data.color||"#8B4513");
  mesh.position.set(data.x||0,data.y||1,data.z||0);
  mesh.add(makeTag(data.name||"Monkey",data.color||"#f5c842"));
  scene.add(mesh);
  remotePlayers[data.id]={
    mesh,
    target:new THREE.Vector3(data.x||0,data.y||1,data.z||0),
    tRY:data.ry||0, moving:false, wt:0
  };
}
function removeRP(id){
  const rp=remotePlayers[id]; if(!rp)return;
  scene.remove(rp.mesh); delete remotePlayers[id];
}
function moveRP(m){
  const rp=remotePlayers[m.id]; if(!rp)return;
  const nv=new THREE.Vector3(m.x,m.y,m.z);
  rp.moving=rp.target.distanceTo(nv)>.02;
  rp.target.copy(nv); rp.tRY=m.ry||0;
}
function updPlayers(){
  document.getElementById("hudPlayers").textContent=`üë• ${Object.keys(remotePlayers).length+1}`;
}

// =====================================================
//   ESC MENU
// =====================================================
function openEsc(){
  escOpen=true;
  document.getElementById("escMenu").classList.remove("hidden");
  document.exitPointerLock();
}
function resumeGame(){
  escOpen=false;
  document.getElementById("escMenu").classList.add("hidden");
  if(!isMobile)setTimeout(()=>canvas.requestPointerLock(),100);
}
function copyCode(){
  navigator.clipboard.writeText(lobbyCode||"").catch(()=>{});
  const b=document.querySelector(".esc-card .btn-secondary");
  const o=b.innerHTML; b.innerHTML="‚úÖ Copied!";
  setTimeout(()=>{b.innerHTML=o;},1500);
}

// =====================================================
//   CHAT
// =====================================================
function openChat(){
  chatOpen=true;
  document.getElementById("chatOverlay").classList.add("on");
  document.exitPointerLock();
  setTimeout(()=>document.getElementById("chatInput").focus(),80);
}
function closeChat(){
  chatOpen=false;
  document.getElementById("chatOverlay").classList.remove("on");
  document.getElementById("chatInput").blur();
  if(!isMobile)setTimeout(()=>canvas.requestPointerLock(),100);
}
function sendChat(){
  const inp=document.getElementById("chatInput");
  const text=inp.value.trim(); if(!text)return;
  if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:"chat",text}));
  inp.value="";
}
document.getElementById("chatInput").addEventListener("keydown",e=>{
  if(e.code==="Enter"){e.preventDefault();sendChat();}
  if(e.code==="Escape"){e.preventDefault();closeChat();}
  e.stopPropagation();
});

function addChatMsg(m){
  const el=document.getElementById("chatMsgs");
  const d=document.createElement("div");
  d.className="cmsg"+(m.isSystem?" sys":"");
  if(m.isSystem){d.textContent=m.text;}
  else{d.innerHTML=`<span class="sndr" style="color:${m.color||"#f5c842"}">${eh(m.sender||"?")}:</span> ${eh(m.text)}`;}
  el.appendChild(d); el.scrollTop=el.scrollHeight;

  // Preview bubble
  if(!chatOpen&&isInGame){
    const prev=document.getElementById("chatPreview");
    const b=document.createElement("div");
    b.className="cprev";
    if(m.isSystem){b.textContent=m.text;}
    else{b.innerHTML=`<span style="font-weight:800;color:${m.color||"#f5c842"}">${eh(m.sender||"?")}:</span> ${eh(m.text)}`;}
    prev.appendChild(b);
    setTimeout(()=>{ if(b.parentNode)b.parentNode.removeChild(b); },4000);
  }
}

// =====================================================
//   TABS
// =====================================================
function switchTab(name){
  const ns=["create","join","browse"];
  document.querySelectorAll(".tab-btn").forEach((b,i)=>b.classList.toggle("active",ns[i]===name));
  document.querySelectorAll(".tab-panel").forEach(p=>p.classList.remove("active"));
  document.getElementById("tab-"+name).classList.add("active");
  if(name==="browse")refreshLobbies();
}
function showErr(msg){
  const el=document.getElementById("errorMsg");
  el.textContent=msg; el.style.display="block";
  clearTimeout(el._t); el._t=setTimeout(()=>{el.style.display="none";},4000);
}
function eh(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

// Prevent iOS bounce / zoom
document.addEventListener("touchmove",e=>{
  if(e.target===canvas||e.target===lZone||e.target===jZone)e.preventDefault();
},{passive:false});
document.addEventListener("gesturestart",e=>e.preventDefault(),{passive:false});

connectWS();
</script>
</body>
</html>
