<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Monkey Tag Online</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;overflow:hidden;font-family:'Courier New',monospace;cursor:default;}
canvas{display:block;position:fixed;top:0;left:0;}
body.ingame{user-select:none;cursor:none;}
#menu-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:300;background:rgba(0,0,0,0.72);touch-action:auto;}
#menu-box{background:rgba(6,14,6,0.99);border:2px solid #00ff44;border-radius:8px;width:min(400px,95vw);max-height:88vh;display:flex;flex-direction:column;box-shadow:0 0 60px rgba(0,255,68,0.3);overflow:hidden;touch-action:auto;}
#menu-title{padding:18px 24px 0;text-align:center;}
#menu-title h1{font-size:clamp(1.4rem,5vw,2rem);font-weight:900;letter-spacing:.1em;color:#00ff44;text-shadow:0 0 30px #00ff44;text-transform:uppercase;margin-bottom:3px;}
#menu-title .sub{color:#335533;font-size:.66rem;letter-spacing:.28em;text-transform:uppercase;margin-bottom:10px;}
#tab-content{padding:14px 20px 16px;overflow-y:auto;flex:1;min-height:0;touch-action:auto;}
.ig{margin-bottom:10px;text-align:left;}
.ig label{color:#557755;font-size:.62rem;letter-spacing:.16em;text-transform:uppercase;display:block;margin-bottom:4px;}
.ig input{width:100%;padding:10px 12px;background:#080f08;border:1px solid #1a331a;color:#00ff44;font-family:'Courier New',monospace;font-size:.95rem;border-radius:3px;outline:none;transition:border-color .2s;touch-action:auto;}
.ig input:focus{border-color:#00ff44;}
.btn{width:100%;padding:12px;margin-top:8px;background:transparent;border:2px solid #00ff44;color:#00ff44;font-family:'Courier New',monospace;font-size:.82rem;font-weight:700;letter-spacing:.16em;text-transform:uppercase;cursor:pointer;border-radius:3px;transition:all .15s;touch-action:auto;-webkit-tap-highlight-color:rgba(0,255,68,0.3);display:block;}
.btn:hover,.btn:active{background:#00ff44;color:#000;box-shadow:0 0 20px rgba(0,255,68,.4);}
.btn.sec{border-color:#1a331a;color:#335533;}
.btn.sec:hover,.btn.sec:active{border-color:#00ff44;color:#00ff44;background:transparent;box-shadow:none;}
.btn:disabled{opacity:.4;pointer-events:none;}
#conn-msg{margin-top:10px;text-align:center;font-size:.65rem;letter-spacing:.1em;padding:6px;border-radius:3px;min-height:22px;}
#conn-msg.err{color:#ff5555;background:rgba(255,50,50,.08);border:1px solid rgba(255,50,50,.2);}
#conn-msg.ok{color:#00ff44;background:rgba(0,255,68,.06);border:1px solid rgba(0,255,68,.15);}
#conn-msg.info{color:#aaffcc;}
#privateBox{display:none;margin-top:10px;}
#hud{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;display:none;z-index:10;}
#crosshair{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:14px;height:14px;}
#crosshair::before,#crosshair::after{content:'';position:absolute;background:rgba(255,255,255,.6);}
#crosshair::before{width:2px;height:14px;left:6px;top:0;}
#crosshair::after{width:14px;height:2px;left:0;top:6px;}
#pcount{position:fixed;top:14px;right:14px;color:#00ff44;font-size:.72rem;letter-spacing:.1em;text-shadow:0 0 8px #00ff44;}
#lcode{position:fixed;top:14px;left:14px;color:#335533;font-size:.65rem;letter-spacing:.06em;}
#hint{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);color:#2a472a;font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;white-space:nowrap;}
#status{position:fixed;bottom:46px;left:50%;transform:translateX(-50%);color:#00ff44;font-size:.75rem;letter-spacing:.08em;text-shadow:0 0 8px #00ff44;opacity:0;transition:opacity .4s;text-transform:uppercase;background:rgba(0,0,0,.7);padding:5px 14px;border-radius:3px;white-space:nowrap;pointer-events:none;}
#menu-btn{position:fixed;top:10px;left:50%;transform:translateX(-50%);padding:6px 16px;background:rgba(0,18,0,0.85);border:1px solid #2a4a2a;color:#446644;font-family:'Courier New',monospace;font-size:.6rem;letter-spacing:.14em;text-transform:uppercase;cursor:pointer;border-radius:3px;pointer-events:all;transition:all .15s;display:none;z-index:60;-webkit-tap-highlight-color:rgba(0,255,68,0.2);touch-action:auto;}
#menu-btn:hover,#menu-btn:active{border-color:#00ff44;color:#00ff44;}
#chat-wrap{position:fixed;bottom:40px;left:14px;width:min(260px,55vw);pointer-events:none;display:none;z-index:55;}
#chat-messages{max-height:150px;overflow-y:auto;display:flex;flex-direction:column;gap:3px;padding-bottom:4px;scrollbar-width:none;}
#chat-messages::-webkit-scrollbar{display:none;}
.chat-msg{background:rgba(0,0,0,0.6);border-radius:3px;padding:3px 8px;font-size:.67rem;color:#aaffcc;letter-spacing:.04em;line-height:1.4;animation:fadeIn .2s ease;word-break:break-word;}
.chat-msg .cname{color:#00ff88;font-weight:700;}
.chat-msg.sys{color:#556655;font-style:italic;}
@keyframes fadeIn{from{opacity:0;transform:translateY(3px);}to{opacity:1;transform:none;}}
#chat-input-row{display:flex;gap:5px;margin-top:5px;pointer-events:all;touch-action:auto;}
#chat-input{flex:1;padding:7px 10px;background:rgba(0,12,0,0.9);border:1px solid #1a441a;color:#00ff44;font-family:'Courier New',monospace;font-size:.74rem;border-radius:3px;outline:none;touch-action:auto;}
#chat-input:focus{border-color:#00ff44;}
#chat-send{padding:7px 10px;background:transparent;border:1px solid #00ff44;color:#00ff44;font-family:'Courier New',monospace;font-size:.68rem;cursor:pointer;border-radius:3px;white-space:nowrap;touch-action:auto;}
#chat-send:active{background:#00ff44;color:#000;}
#chat-toggle-btn{position:fixed;bottom:140px;right:28px;width:56px;height:56px;border-radius:50%;background:rgba(0,25,0,0.88);border:2px solid rgba(0,200,80,0.5);color:#00ff88;font-size:1.3rem;display:none;align-items:center;justify-content:center;pointer-events:all;cursor:pointer;z-index:60;-webkit-tap-highlight-color:rgba(0,255,68,0.2);touch-action:auto;}
#chat-unread{position:absolute;top:-3px;right:-3px;background:#ff4444;color:#fff;font-size:.52rem;width:15px;height:15px;border-radius:50%;display:none;align-items:center;justify-content:center;font-weight:700;}
#mobile-controls{position:fixed;bottom:0;left:0;width:100%;height:100%;pointer-events:none;display:none;z-index:50;touch-action:none;}
#joy-zone{position:absolute;bottom:0;left:0;width:50%;height:100%;pointer-events:all;touch-action:none;}
#joy-base{position:absolute;width:110px;height:110px;border-radius:50%;background:rgba(255,255,255,0.07);border:2px solid rgba(255,255,255,0.2);transform:translate(-50%,-50%);display:none;}
#joy-stick{position:absolute;width:48px;height:48px;border-radius:50%;background:rgba(0,255,130,0.5);border:2px solid rgba(0,255,130,0.85);box-shadow:0 0 14px rgba(0,255,130,0.45);transform:translate(-50%,-50%);display:none;}
#look-zone{position:absolute;bottom:0;right:0;width:50%;height:100%;pointer-events:all;touch-action:none;}
#jump-btn{position:absolute;bottom:40px;right:28px;width:80px;height:80px;border-radius:50%;background:rgba(0,255,100,0.14);border:3px solid rgba(0,255,100,0.55);box-shadow:0 0 18px rgba(0,255,100,0.18);display:flex;align-items:center;justify-content:center;color:#00ff88;font-size:1.5rem;font-weight:900;pointer-events:all;transition:background .1s,transform .1s;-webkit-tap-highlight-color:transparent;user-select:none;touch-action:none;}
#jump-btn:active,#jump-btn.pressed{background:rgba(0,255,100,0.38);transform:scale(.92);}
</style>
</head>
<body>
<canvas id="c"></canvas>

<!-- â”€â”€ MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="menu-overlay">
  <div id="menu-box">
    <div id="menu-title">
      <h1>ğŸ¦ Monkey Tag</h1>
      <div class="sub">online Â· multiplayer</div>
    </div>
    <div id="tab-content">
      <div class="ig">
        <label>Your Name</label>
        <input type="text" id="nameInput" placeholder="Enter name..." maxlength="16" value="Monkey">
      </div>
      <div class="ig">
        <label>Server (Railway WSS URL)</label>
        <input type="text" id="serverInput" placeholder="wss://your-app.railway.app" value="">
      </div>
      <button class="btn" id="joinPublicBtn">â–¶ Join Public Lobby</button>
      <button class="btn sec" id="hostBtn">âŠ• Host Private Lobby</button>
      <div id="privateBox">
        <div class="ig">
          <label>Lobby Code</label>
          <input type="text" id="codeInput" placeholder="Enter code..." maxlength="8">
        </div>
        <button class="btn" id="joinPrivBtn">â†’ Join Private</button>
      </div>
      <div id="conn-msg"></div>
    </div>
  </div>
</div>

<!-- â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="hud">
  <div id="crosshair"></div>
  <div id="pcount">Players: 1</div>
  <div id="lcode"></div>
  <div id="hint">WASD Â· Move &nbsp;|&nbsp; SPACE Â· Jump &nbsp;|&nbsp; MOUSE Â· Look &nbsp;|&nbsp; T Â· Chat &nbsp;|&nbsp; ESC Â· Menu</div>
  <div id="status"></div>
  <button id="menu-btn">â˜° Menu</button>
</div>

<!-- â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="chat-wrap">
  <div id="chat-messages"></div>
  <div id="chat-input-row">
    <input type="text" id="chat-input" placeholder="Say something..." maxlength="80" autocomplete="off">
    <button id="chat-send">Send</button>
  </div>
</div>
<div id="chat-toggle-btn">ğŸ’¬<div id="chat-unread"></div></div>

<!-- â”€â”€ MOBILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="mobile-controls">
  <div id="joy-zone"><div id="joy-base"></div><div id="joy-stick"></div></div>
  <div id="look-zone"></div>
  <div id="jump-btn">â–²</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GRAVITY   = -22;
const JUMP_VEL  = 9;
const SPEED     = 7;
const PLAYER_H  = 1.8;   // camera height above feet
const SEND_HZ   = 20;    // network send rate

const PLATFORMS = [
  // Ground
  { x:0,   y:-0.3, z:0,   sx:50,  sy:0.6, sz:50  },
  // Raised platforms
  { x:8,   y:2.2,  z:-6,  sx:7,   sy:0.5, sz:7   },
  { x:-10, y:3.5,  z:7,   sx:7,   sy:0.5, sz:7   },
  { x:0,   y:5.5,  z:0,   sx:9,   sy:0.5, sz:9   },
  { x:14,  y:3,    z:10,  sx:6,   sy:0.5, sz:6   },
  { x:-14, y:4.5,  z:-10, sx:6,   sy:0.5, sz:6   },
  { x:0,   y:8,    z:-14, sx:8,   sy:0.5, sz:6   },
  { x:-6,  y:1.5,  z:-16, sx:5,   sy:0.5, sz:5   },
  { x:18,  y:6,    z:-4,  sx:5,   sy:0.5, sz:5   },
];

const MONKEY_COLORS = [0xff6600,0xff3399,0x33aaff,0xffee00,0x44ff66,0xff4444,0xaa44ff,0xff9900];
const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THREE.JS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.setClearColor(0x061206);

const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x061206, 0.018);

const camera = new THREE.PerspectiveCamera(75, 1, 0.05, 200);

// Lights
const ambient = new THREE.AmbientLight(0x223322, 0.9);
scene.add(ambient);

const sun = new THREE.DirectionalLight(0xaaffaa, 1.1);
sun.position.set(15, 30, 10);
sun.castShadow = true;
sun.shadow.mapSize.set(1024, 1024);
sun.shadow.camera.near = 0.5;
sun.shadow.camera.far = 100;
sun.shadow.camera.left = sun.shadow.camera.bottom = -30;
sun.shadow.camera.right = sun.shadow.camera.top = 30;
scene.add(sun);

const glow = new THREE.PointLight(0x00ff44, 0.5, 50);
glow.position.set(0, 12, 0);
scene.add(glow);

// Stars
(function buildStars() {
  const geo = new THREE.BufferGeometry();
  const pos = [];
  for (let i = 0; i < 1500; i++) {
    pos.push(
      (Math.random() - 0.5) * 250,
      Math.random() * 80 + 10,
      (Math.random() - 0.5) * 250
    );
  }
  geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
  const mat = new THREE.PointsMaterial({ color: 0x88ffaa, size: 0.25, transparent: true, opacity: 0.6 });
  scene.add(new THREE.Points(geo, mat));
})();

// Platforms
const platMat = new THREE.MeshLambertMaterial({ color: 0x0d2a0d });
const platEdge = new THREE.MeshLambertMaterial({ color: 0x00ff44, emissive: 0x003300 });
const platMeshes = [];

PLATFORMS.forEach((p, i) => {
  const geo = new THREE.BoxGeometry(p.sx, p.sy, p.sz);
  const mat = i === 0 ? platMat : platEdge;
  const mesh = new THREE.Mesh(geo, mat);
  mesh.position.set(p.x, p.y, p.z);
  mesh.receiveShadow = true;
  mesh.castShadow = false;
  scene.add(mesh);
  platMeshes.push(mesh);
  // Wire overlay for non-ground platforms
  if (i > 0) {
    const wire = new THREE.LineSegments(
      new THREE.EdgesGeometry(geo),
      new THREE.LineBasicMaterial({ color: 0x00ff44, transparent: true, opacity: 0.3 })
    );
    mesh.add(wire);
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYER MONKEY MESH BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeMonkeyMesh(color) {
  const g = new THREE.Group();

  const bodyGeo = new THREE.CylinderGeometry(0.28, 0.28, 0.85, 8);
  const bodyMat = new THREE.MeshLambertMaterial({ color });
  const body = new THREE.Mesh(bodyGeo, bodyMat);
  body.position.y = 0.42;
  body.castShadow = true;
  g.add(body);

  const headGeo = new THREE.SphereGeometry(0.28, 8, 8);
  const head = new THREE.Mesh(headGeo, new THREE.MeshLambertMaterial({ color }));
  head.position.y = 1.12;
  head.castShadow = true;
  g.add(head);

  // Face
  const faceGeo = new THREE.SphereGeometry(0.16, 6, 6);
  const face = new THREE.Mesh(faceGeo, new THREE.MeshLambertMaterial({ color: 0xffcc88 }));
  face.position.set(0, 1.1, 0.22);
  face.scale.set(1, 0.75, 0.6);
  g.add(face);

  // Eyes
  [-0.09, 0.09].forEach(ox => {
    const eye = new THREE.Mesh(
      new THREE.SphereGeometry(0.04, 5, 5),
      new THREE.MeshLambertMaterial({ color: 0x000000 })
    );
    eye.position.set(ox, 1.18, 0.27);
    g.add(eye);
  });

  // Arms
  [-0.35, 0.35].forEach(ox => {
    const arm = new THREE.Mesh(
      new THREE.CylinderGeometry(0.07, 0.06, 0.6, 6),
      new THREE.MeshLambertMaterial({ color })
    );
    arm.rotation.z = ox > 0 ? -0.5 : 0.5;
    arm.position.set(ox * 1.2, 0.55, 0);
    arm.castShadow = true;
    g.add(arm);
  });

  // Legs
  [-0.12, 0.12].forEach(ox => {
    const leg = new THREE.Mesh(
      new THREE.CylinderGeometry(0.08, 0.07, 0.55, 6),
      new THREE.MeshLambertMaterial({ color })
    );
    leg.position.set(ox, -0.02, 0);
    leg.castShadow = true;
    g.add(leg);
  });

  // Tail
  const tailCurve = new THREE.CatmullRomCurve3([
    new THREE.Vector3(0, 0.3, -0.28),
    new THREE.Vector3(-0.3, 0.5, -0.45),
    new THREE.Vector3(-0.5, 0.8, -0.35),
    new THREE.Vector3(-0.4, 1.0, -0.15),
  ]);
  const tailGeo = new THREE.TubeGeometry(tailCurve, 8, 0.04, 5, false);
  const tail = new THREE.Mesh(tailGeo, new THREE.MeshLambertMaterial({ color }));
  g.add(tail);

  return g;
}

// Name sprite
function makeNameSprite(name) {
  const cv = document.createElement('canvas');
  cv.width = 256; cv.height = 48;
  const ctx = cv.getContext('2d');
  ctx.clearRect(0, 0, 256, 48);
  ctx.font = 'bold 26px Courier New, monospace';
  ctx.textAlign = 'center';
  ctx.fillStyle = '#00ff88';
  ctx.shadowColor = '#00ff44';
  ctx.shadowBlur = 8;
  ctx.fillText(name, 128, 32);
  const tex = new THREE.CanvasTexture(cv);
  const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, depthTest: false });
  const sprite = new THREE.Sprite(mat);
  sprite.scale.set(2.2, 0.44, 1);
  sprite.position.y = 1.85;
  return sprite;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYER STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const pl = { x: 0, y: 3, z: 5, vx: 0, vy: 0, vz: 0, yaw: 0, pitch: 0, onGround: false };
const keys = {};
let myId = null;
let myColor = MONKEY_COLORS[Math.floor(Math.random() * MONKEY_COLORS.length)];
let myName = 'Monkey';
let lobbyId = null;

// Remote players: id -> { mesh, nameSprite, tx, ty, tz, tyaw }
const remotes = {};

// â”€â”€â”€ Physics helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function platTopY(p)  { return p.y + p.sy / 2; }
function platAABB(p)  { return { minX: p.x - p.sx/2, maxX: p.x + p.sx/2, minZ: p.z - p.sz/2, maxZ: p.z + p.sz/2 }; }
const PR = 0.28; // player radius

function resolvePhysics(dt) {
  pl.vy += GRAVITY * dt;
  pl.y  += pl.vy * dt;
  pl.x  += pl.vx * dt;
  pl.z  += pl.vz * dt;

  pl.onGround = false;

  for (const p of PLATFORMS) {
    const top  = platTopY(p);
    const bb   = platAABB(p);
    const inXZ = pl.x + PR > bb.minX && pl.x - PR < bb.maxX &&
                 pl.z + PR > bb.minZ && pl.z - PR < bb.maxZ;

    if (!inXZ) continue;

    // Landing on top
    if (pl.vy <= 0 && pl.y >= top - 0.05 && pl.y - pl.vy * dt <= top + 0.5) {
      pl.y = top;
      pl.vy = 0;
      pl.onGround = true;
    }
    // Hitting bottom
    if (pl.vy > 0 && pl.y < p.y - p.sy / 2 + 0.1) {
      pl.vy = 0;
    }
  }

  // World boundary
  const WALL = 24;
  if (pl.x >  WALL) { pl.x =  WALL; pl.vx = 0; }
  if (pl.x < -WALL) { pl.x = -WALL; pl.vx = 0; }
  if (pl.z >  WALL) { pl.z =  WALL; pl.vz = 0; }
  if (pl.z < -WALL) { pl.z = -WALL; pl.vz = 0; }

  // Fall pit reset
  if (pl.y < -12) { pl.x = 0; pl.y = 5; pl.z = 5; pl.vy = 0; pl.vx = 0; pl.vz = 0; }
}

// â”€â”€â”€ Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
  keys[e.code] = true;
  if (e.code === 'KeyT' && inGame && !chatActive()) { e.preventDefault(); openChat(); }
  if (e.code === 'Escape' && inGame) showMenu();
  if (e.code === 'Enter' && chatActive()) sendChat();
});
document.addEventListener('keyup', e => { keys[e.code] = false; });

// Mouse look
let pointerLocked = false;
canvas.addEventListener('click', () => { if (inGame) canvas.requestPointerLock(); });
document.addEventListener('pointerlockchange', () => {
  pointerLocked = document.pointerLockElement === canvas;
});
document.addEventListener('mousemove', e => {
  if (!pointerLocked || !inGame) return;
  pl.yaw   -= e.movementX * 0.002;
  pl.pitch -= e.movementY * 0.002;
  pl.pitch  = Math.max(-1.3, Math.min(1.3, pl.pitch));
});
// Right-click alternative look (no pointer lock)
let rmb = false;
canvas.addEventListener('mousedown', e => { if (e.button === 2) rmb = true; });
canvas.addEventListener('mouseup',   e => { if (e.button === 2) rmb = false; });
canvas.addEventListener('contextmenu', e => e.preventDefault());

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOBILE CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const joyBase  = document.getElementById('joy-base');
const joyStick = document.getElementById('joy-stick');
const joyZone  = document.getElementById('joy-zone');
const lookZone = document.getElementById('look-zone');
const jumpBtn  = document.getElementById('jump-btn');

let joyActive = false, joyTouchId = null, joyOrigin = {x:0,y:0};
let joyDir = {x:0,y:0};
let lookTouchId = null, lookLast = {x:0,y:0};

if (isMobile) {
  joyZone.addEventListener('touchstart', e => {
    e.preventDefault();
    const t = e.changedTouches[0];
    joyTouchId = t.identifier;
    joyOrigin = { x: t.clientX, y: t.clientY };
    joyActive = true;
    joyBase.style.left = t.clientX + 'px';
    joyBase.style.top  = t.clientY + 'px';
    joyStick.style.left = t.clientX + 'px';
    joyStick.style.top  = t.clientY + 'px';
    joyBase.style.display = joyStick.style.display = 'block';
  }, { passive: false });

  joyZone.addEventListener('touchmove', e => {
    e.preventDefault();
    for (const t of e.changedTouches) {
      if (t.identifier !== joyTouchId) continue;
      const dx = t.clientX - joyOrigin.x;
      const dy = t.clientY - joyOrigin.y;
      const len = Math.sqrt(dx*dx + dy*dy);
      const max = 45;
      const cx = len > max ? (dx/len)*max : dx;
      const cy = len > max ? (dy/len)*max : dy;
      joyStick.style.left = (joyOrigin.x + cx) + 'px';
      joyStick.style.top  = (joyOrigin.y + cy) + 'px';
      joyDir = { x: cx/max, y: cy/max };
    }
  }, { passive: false });

  const joyEnd = (e) => {
    e.preventDefault();
    for (const t of e.changedTouches) {
      if (t.identifier === joyTouchId) {
        joyActive = false; joyDir = {x:0,y:0};
        joyBase.style.display = joyStick.style.display = 'none';
      }
    }
  };
  joyZone.addEventListener('touchend', joyEnd, { passive: false });
  joyZone.addEventListener('touchcancel', joyEnd, { passive: false });

  lookZone.addEventListener('touchstart', e => {
    e.preventDefault();
    const t = e.changedTouches[0];
    lookTouchId = t.identifier;
    lookLast = { x: t.clientX, y: t.clientY };
  }, { passive: false });

  lookZone.addEventListener('touchmove', e => {
    e.preventDefault();
    for (const t of e.changedTouches) {
      if (t.identifier !== lookTouchId) continue;
      const dx = t.clientX - lookLast.x;
      const dy = t.clientY - lookLast.y;
      pl.yaw   -= dx * 0.004;
      pl.pitch -= dy * 0.004;
      pl.pitch  = Math.max(-1.3, Math.min(1.3, pl.pitch));
      lookLast = { x: t.clientX, y: t.clientY };
    }
  }, { passive: false });

  const lookEnd = e => {
    for (const t of e.changedTouches)
      if (t.identifier === lookTouchId) lookTouchId = null;
  };
  lookZone.addEventListener('touchend', lookEnd);
  lookZone.addEventListener('touchcancel', lookEnd);

  jumpBtn.addEventListener('touchstart', e => {
    e.preventDefault();
    if (pl.onGround) pl.vy = JUMP_VEL;
    jumpBtn.classList.add('pressed');
  }, { passive: false });
  jumpBtn.addEventListener('touchend', () => jumpBtn.classList.remove('pressed'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ws = null;
let inGame = false;
let unread = 0;

function connect(lobbyIdStr) {
  if (ws) { ws.onclose = null; ws.close(); ws = null; }

  let serverUrl = document.getElementById('serverInput').value.trim();
  if (!serverUrl) { setConnMsg('Enter your Railway WSS URL first', 'err'); return; }

  // Auto-fix URL: strip trailing slash, add wss:// if missing
  serverUrl = serverUrl.replace(/\/$/, '');
  if (!/^wss?:\/\//i.test(serverUrl)) {
    const isLocal = serverUrl.startsWith('localhost') || serverUrl.startsWith('127.');
    serverUrl = (isLocal ? 'ws://' : 'wss://') + serverUrl;
    document.getElementById('serverInput').value = serverUrl;
  }

  lobbyId = lobbyIdStr;
  myName  = (document.getElementById('nameInput').value.trim() || 'Monkey').slice(0, 16);

  setConnMsg('Connecting to ' + serverUrl + '...', 'info');
  disableBtns(true);
  showCancelBtn(true);

  let didConnect = false;

  try {
    ws = new WebSocket(serverUrl);
  } catch(e) {
    setConnMsg('Bad URL: ' + e.message, 'err');
    disableBtns(false);
    showCancelBtn(false);
    return;
  }

  const timeout = setTimeout(() => {
    if (!didConnect) {
      ws.onclose = null; ws.close(); ws = null;
      setConnMsg('Timed out (5s) - is your Railway server running? Check the URL.', 'err');
      disableBtns(false);
      showCancelBtn(false);
    }
  }, 5000);

  ws.onopen = () => {
    didConnect = true;
    clearTimeout(timeout);
    setConnMsg('Connected! Joining lobby...', 'ok');
    ws.send(JSON.stringify({ type: 'join', lobby: lobbyId, name: myName, color: myColor }));
  };

  ws.onmessage = e => {
    let msg;
    try { msg = JSON.parse(e.data); } catch { return; }
    handleMsg(msg);
  };

  ws.onerror = () => {
    clearTimeout(timeout);
    if (!didConnect) {
      setConnMsg('Connection refused - make sure Railway is deployed & URL uses wss://', 'err');
      disableBtns(false);
      showCancelBtn(false);
    }
  };

  ws.onclose = (ev) => {
    clearTimeout(timeout);
    showCancelBtn(false);
    if (inGame) {
      showStatus('Disconnected (code ' + ev.code + ')');
      setTimeout(showMenu, 2500);
    } else if (didConnect && !inGame) {
      setConnMsg('Server closed connection - code ' + ev.code, 'err');
      disableBtns(false);
    }
  };
}

function showCancelBtn(show) {
  let btn = document.getElementById('cancelBtn');
  if (!btn) {
    btn = document.createElement('button');
    btn.id = 'cancelBtn';
    btn.className = 'btn sec';
    btn.textContent = 'Cancel';
    btn.style.marginTop = '6px';
    btn.onclick = () => {
      if (ws) { ws.onclose = null; ws.close(); ws = null; }
      setConnMsg('Cancelled.', 'info');
      disableBtns(false);
      showCancelBtn(false);
    };
    document.getElementById('tab-content').appendChild(btn);
  }
  btn.style.display = show ? 'block' : 'none';
}

function handleMsg(msg) {
  switch (msg.type) {

    case 'welcome':
      myId = msg.id;
      setConnMsg('Connected! Entering gameâ€¦', 'ok');
      setTimeout(enterGame, 400);
      break;

    case 'state':
      // Snapshot of all current players
      Object.entries(msg.players).forEach(([id, p]) => {
        if (id === myId) return;
        spawnRemote(id, p);
        updateRemotePos(id, p);
      });
      updatePCount();
      break;

    case 'player_join':
      if (msg.id === myId) break;
      spawnRemote(msg.id, { name: msg.name, color: msg.color || 0xff6600 });
      addChatMsg(`${msg.name} joined`, true);
      updatePCount();
      break;

    case 'player_move':
      if (msg.id === myId) break;
      if (!remotes[msg.id]) spawnRemote(msg.id, { name: msg.name, color: msg.color || 0xff6600 });
      updateRemotePos(msg.id, msg);
      break;

    case 'player_leave':
      if (remotes[msg.id]) {
        scene.remove(remotes[msg.id].group);
        delete remotes[msg.id];
        updatePCount();
      }
      addChatMsg(`${msg.name} left`, true);
      break;

    case 'chat':
      addChatMsg(null, false, msg.name, msg.text);
      break;
  }
}

function spawnRemote(id, data) {
  if (remotes[id]) return;
  const color = typeof data.color === 'number' ? data.color : 0xff6600;
  const group = makeMonkeyMesh(color);
  const nameSprite = makeNameSprite(data.name || '?');
  group.add(nameSprite);
  scene.add(group);
  remotes[id] = { group, nameSprite, tx:0, ty:0, tz:0, tyaw:0 };
}

function updateRemotePos(id, p) {
  if (!remotes[id]) return;
  remotes[id].tx   = p.x;
  remotes[id].ty   = p.y;
  remotes[id].tz   = p.z;
  remotes[id].tyaw = p.yaw;
}

function updatePCount() {
  document.getElementById('pcount').textContent = 'Players: ' + (Object.keys(remotes).length + 1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastTime = 0;
let sendTimer = 0;
let myMonkey = null;

function enterGame() {
  // Hide menu, show game UI
  document.getElementById('menu-overlay').style.display = 'none';
  document.getElementById('hud').style.display = 'block';
  document.getElementById('menu-btn').style.display = 'block';
  document.getElementById('chat-wrap').style.display = 'block';
  if (isMobile) {
    document.getElementById('mobile-controls').style.display = 'block';
    document.getElementById('chat-toggle-btn').style.display = 'flex';
    document.getElementById('chat-wrap').style.pointerEvents = 'none';
    document.getElementById('chat-wrap').style.opacity = '0';
  }
  document.body.classList.add('ingame');
  inGame = true;

  // Show lobby code
  document.getElementById('lcode').textContent = 'Lobby: ' + lobbyId;

  // Build local monkey (hidden â€” camera is first-person)
  if (myMonkey) scene.remove(myMonkey);
  myMonkey = makeMonkeyMesh(myColor);
  myMonkey.visible = false; // first-person: hide self
  scene.add(myMonkey);

  // Reset position
  pl.x = (Math.random() - 0.5) * 6;
  pl.y = 3;
  pl.z = (Math.random() - 0.5) * 6;
  pl.vx = pl.vy = pl.vz = 0;
  pl.yaw = 0; pl.pitch = 0;

  resize();
  requestAnimationFrame(loop);
}

function loop(t) {
  if (!inGame) return;
  requestAnimationFrame(loop);

  const dt = Math.min((t - lastTime) / 1000, 0.05);
  lastTime = t;

  update(dt);
  render();

  // Network send
  sendTimer += dt;
  if (sendTimer >= 1 / SEND_HZ) {
    sendTimer = 0;
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({
        type: 'move',
        x: +pl.x.toFixed(3),
        y: +pl.y.toFixed(3),
        z: +pl.z.toFixed(3),
        yaw: +pl.yaw.toFixed(4),
        name: myName,
        color: myColor
      }));
    }
  }
}

function update(dt) {
  if (chatActive()) { pl.vx = 0; pl.vz = 0; resolvePhysics(dt); return; }

  // Movement
  const sin = Math.sin(pl.yaw);
  const cos = Math.cos(pl.yaw);
  let mx = 0, mz = 0;

  if (isMobile) {
    mx = joyDir.x;
    mz = joyDir.y;
  } else {
    if (keys['KeyW'] || keys['ArrowUp'])    mz = -1;
    if (keys['KeyS'] || keys['ArrowDown'])  mz =  1;
    if (keys['KeyA'] || keys['ArrowLeft'])  mx = -1;
    if (keys['KeyD'] || keys['ArrowRight']) mx =  1;
  }

  const len = Math.sqrt(mx*mx + mz*mz);
  if (len > 0) { mx /= len; mz /= len; }

  pl.vx = (mx * cos - mz * sin) * SPEED;
  pl.vz = (mx * sin + mz * cos) * SPEED;

  if (keys['Space'] && pl.onGround && !isMobile) pl.vy = JUMP_VEL;

  resolvePhysics(dt);

  // Lerp remote players
  for (const r of Object.values(remotes)) {
    r.group.position.x += (r.tx - r.group.position.x) * 0.2;
    r.group.position.y += (r.ty - r.group.position.y) * 0.2;
    r.group.position.z += (r.tz - r.group.position.z) * 0.2;
    r.group.rotation.y = r.tyaw;
    // Animate legs
    r.group.children.forEach((c, i) => {
      if (i === 6 || i === 7) { // legs
        c.rotation.x = Math.sin(Date.now() * 0.008 + i) * 0.3;
      }
    });
  }
}

function render() {
  // Position camera (first-person)
  camera.position.set(pl.x, pl.y + PLAYER_H * 0.8, pl.z);
  camera.rotation.order = 'YXZ';
  camera.rotation.y = pl.yaw;
  camera.rotation.x = pl.pitch;

  renderer.render(scene, camera);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setConnMsg(txt, cls) {
  const el = document.getElementById('conn-msg');
  el.textContent = txt;
  el.className = cls || '';
}

function disableBtns(dis) {
  ['joinPublicBtn','hostBtn','joinPrivBtn'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.disabled = dis;
  });
}

let statusTimeout = null;
function showStatus(txt) {
  const el = document.getElementById('status');
  el.textContent = txt;
  el.style.opacity = '1';
  clearTimeout(statusTimeout);
  statusTimeout = setTimeout(() => { el.style.opacity = '0'; }, 3000);
}

function showMenu() {
  if (document.exitPointerLock) document.exitPointerLock();
  inGame = false;
  document.getElementById('menu-overlay').style.display = 'flex';
  document.getElementById('hud').style.display = 'none';
  document.getElementById('menu-btn').style.display = 'none';
  document.getElementById('chat-wrap').style.display = 'none';
  document.getElementById('mobile-controls').style.display = 'none';
  document.getElementById('chat-toggle-btn').style.display = 'none';
  document.body.classList.remove('ingame');
  disableBtns(false);
  setConnMsg('');

  // Clean up remote players
  Object.values(remotes).forEach(r => scene.remove(r.group));
  for (const k in remotes) delete remotes[k];
  if (myMonkey) { scene.remove(myMonkey); myMonkey = null; }
  myId = null; lobbyId = null;
}

// â”€â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function chatActive() {
  return document.activeElement === document.getElementById('chat-input');
}

function openChat() {
  document.getElementById('chat-input').focus();
  if (isMobile) {
    document.getElementById('chat-wrap').style.opacity = '1';
    document.getElementById('chat-wrap').style.pointerEvents = 'all';
  }
  unread = 0;
  const un = document.getElementById('chat-unread');
  un.style.display = 'none';
}

function sendChat() {
  const inp = document.getElementById('chat-input');
  const txt = inp.value.trim();
  if (!txt) { inp.blur(); return; }
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'chat', text: txt }));
  }
  // Show own message locally
  addChatMsg(null, false, myName, txt);
  inp.value = '';
  inp.blur();
}

function addChatMsg(sysText, isSys, name, text) {
  const box = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'chat-msg' + (isSys ? ' sys' : '');
  if (isSys) {
    div.textContent = sysText;
  } else {
    div.innerHTML = `<span class="cname">${escHtml(name)}</span>: ${escHtml(text)}`;
  }
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
  // Trim old messages
  while (box.children.length > 40) box.removeChild(box.firstChild);

  // Unread badge
  if (!chatActive() && isMobile) {
    unread++;
    const un = document.getElementById('chat-unread');
    un.textContent = unread;
    un.style.display = 'flex';
  }
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€â”€ Chat toggle (mobile) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('chat-toggle-btn').addEventListener('click', () => {
  const wrap = document.getElementById('chat-wrap');
  const isOpen = wrap.style.opacity === '1';
  wrap.style.opacity = isOpen ? '0' : '1';
  wrap.style.pointerEvents = isOpen ? 'none' : 'all';
  unread = 0;
  document.getElementById('chat-unread').style.display = 'none';
  if (!isOpen) document.getElementById('chat-input').focus();
});

document.getElementById('chat-send').addEventListener('click', sendChat);
document.getElementById('chat-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') { e.preventDefault(); sendChat(); }
  e.stopPropagation();
});

// â”€â”€â”€ Menu buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('joinPublicBtn').addEventListener('click', () => {
  connect('public');
});

document.getElementById('hostBtn').addEventListener('click', () => {
  const box = document.getElementById('privateBox');
  const open = box.style.display === 'block';
  if (open) {
    // Generate code and host
    const code = Math.random().toString(36).substring(2, 8).toUpperCase();
    document.getElementById('codeInput').value = code;
    connect(code);
  } else {
    box.style.display = 'block';
    setConnMsg('Enter a code (or generate one by clicking Host again)', 'info');
  }
});

document.getElementById('joinPrivBtn').addEventListener('click', () => {
  const code = document.getElementById('codeInput').value.trim().toLowerCase();
  if (!code) { setConnMsg('Enter a lobby code', 'err'); return; }
  connect(code);
});

document.getElementById('menu-btn').addEventListener('click', showMenu);

// â”€â”€â”€ Resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resize() {
  const w = window.innerWidth, h = window.innerHeight;
  renderer.setSize(w, h);
  camera.aspect = w / h;
  camera.updateProjectionMatrix();
}
window.addEventListener('resize', resize);
resize();

// â”€â”€â”€ Idle render loop (before game starts) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let idleRaf;
function idleLoop(t) {
  if (inGame) return;
  idleRaf = requestAnimationFrame(idleLoop);
  // Slowly orbit camera for menu background
  const a = t * 0.0003;
  camera.position.set(Math.sin(a) * 18, 8 + Math.sin(a * 0.5) * 3, Math.cos(a) * 18);
  camera.lookAt(0, 2, 0);
  renderer.render(scene, camera);
}
requestAnimationFrame(idleLoop);

// â”€â”€â”€ Auto-detect server URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Try to pre-fill if running on Railway domain
(function autoFill() {
  const host = location.hostname;
  if (host === 'localhost' || host === '127.0.0.1') {
    document.getElementById('serverInput').value = 'ws://localhost:8080';
  }
  // Otherwise leave blank for user to fill in Railway WSS URL
})();
</script>
</body>
</html>
